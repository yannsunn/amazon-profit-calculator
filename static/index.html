<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="description" content="è¤‡æ•°ã®Amazonã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨è²©è·¯ã®CSVãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆã—ã€æœˆæ¬¡åˆ©ç›Šã‚’è‡ªå‹•è¨ˆç®—ã™ã‚‹Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³">
    <meta name="theme-color" content="#3498db">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Amazonåˆ©ç›Šè¨ˆç®—">
    <meta name="format-detection" content="telephone=no">
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <title>Amazonå£²ä¸Šåˆ©ç›Šè¨ˆç®—ã‚·ã‚¹ãƒ†ãƒ ï¼ˆå®Œå…¨ç‰ˆï¼‰</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: #2c3e50;
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .header p {
            font-size: 1rem;
            opacity: 0.9;
        }
        
        .main-content {
            padding: 40px;
        }
        
        .upload-section {
            margin-bottom: 40px;
        }
        
        .upload-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .account-section {
            margin-bottom: 40px;
        }
        
        .account-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
        }
        
        .mercari-section {
            margin: 40px 0;
            text-align: center;
        }
        
        .mercari-section .upload-item {
            max-width: 400px;
            margin: 0 auto;
        }
        
        .section-title {
            font-weight: 600;
            color: #2c3e50;
            margin: 15px 0 10px 0;
            padding-bottom: 5px;
            border-bottom: 1px solid #ecf0f1;
            font-size: 0.9rem;
        }
        
        .month-selection {
            margin-bottom: 40px;
            text-align: center;
        }
        
        .month-selector {
            margin: 20px 0;
        }
        
        .month-select {
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
            color: #333;
            min-width: 250px;
            cursor: pointer;
        }
        
        .month-select:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .saved-months {
            margin: 40px 0;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .saved-months h3 {
            margin-bottom: 20px;
            color: #2c3e50;
        }
        
        .month-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .month-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .month-card:hover {
            border-color: #3498db;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .month-card.has-data {
            border-color: #27ae60;
            background: #f0f8f3;
        }
        
        .month-card-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .month-card-status {
            font-size: 0.9rem;
            color: #7f8c8d;
        }
        
        .month-card.has-data .month-card-status {
            color: #27ae60;
        }
        
        .upload-item {
            border: 2px dashed #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            transition: all 0.2s ease;
            background: #fafafa;
            position: relative;
            cursor: pointer;
        }
        
        .upload-item:hover {
            border-color: #2c3e50;
            background: #f8f8f8;
        }
        
        .upload-item.has-file {
            border-color: #27ae60;
            background: #f0f8f3;
        }
        
        .upload-item.drag-over {
            border-color: #3498db;
            background: #e3f2fd;
            transform: scale(1.02);
        }
        
        .upload-item.drag-over::before {
            content: 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ãã ã•ã„';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.1rem;
            font-weight: 600;
            color: #3498db;
            z-index: 10;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 20px;
            border-radius: 4px;
        }
        
        .upload-instruction {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-top: 10px;
        }
        
        .upload-item h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        
        .file-input {
            display: none;
        }
        
        .file-label {
            display: inline-block;
            padding: 10px 20px;
            background: #3498db;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s ease;
            font-weight: 500;
        }
        
        .file-label:hover {
            background: #2980b9;
        }
        
        .file-name {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #27ae60;
            font-weight: 500;
        }
        
        .button-section {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin: 40px 0;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 160px;
        }
        
        .btn-validate {
            background: #95a5a6;
            color: white;
        }
        
        .btn-validate:hover {
            background: #7f8c8d;
        }
        
        .btn-calculate {
            background: #27ae60;
            color: white;
        }
        
        .btn-calculate:hover {
            background: #229954;
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .results-section {
            margin-top: 40px;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 8px;
            display: none;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background: white;
            padding: 25px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border-left: 4px solid #3498db;
        }
        
        .summary-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        
        .summary-card h3 {
            color: #7f8c8d;
            font-size: 0.85rem;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }
        
        .summary-card .value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .summary-card.sales {
            border-left-color: #3498db;
        }
        
        .summary-card.profit {
            border-left-color: #27ae60;
        }
        
        .summary-card.rate {
            border-left-color: #f39c12;
        }
        
        .summary-card.months {
            border-left-color: #9b59b6;
        }
        
        .change-indicator {
            font-size: 0.8rem;
            margin-top: 5px;
            font-weight: 500;
        }
        
        .change-positive {
            color: #27ae60;
        }
        
        .change-negative {
            color: #e74c3c;
        }
        
        .change-neutral {
            color: #7f8c8d;
        }
        
        .trend-section {
            margin: 30px 0;
            padding: 25px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .trend-section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.1rem;
        }
        
        .trend-chart {
            display: flex;
            align-items: end;
            height: 150px;
            gap: 8px;
            padding: 10px 0;
            border-bottom: 2px solid #ecf0f1;
            position: relative;
        }
        
        .trend-bar {
            flex: 1;
            background: linear-gradient(to top, #3498db, #5dade2);
            border-radius: 4px 4px 0 0;
            min-height: 10px;
            position: relative;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .trend-bar:hover {
            background: linear-gradient(to top, #2980b9, #3498db);
            transform: scaleY(1.05);
        }
        
        .trend-bar-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8rem;
            color: #7f8c8d;
            white-space: nowrap;
        }
        
        .trend-bar-value {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.75rem;
            color: #2c3e50;
            background: rgba(255,255,255,0.9);
            padding: 2px 6px;
            border-radius: 3px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .trend-bar:hover .trend-bar-value {
            opacity: 1;
        }

        /* ä¿å­˜æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ç®¡ç† */
        .saved-data-section {
            margin: 30px 0;
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .saved-data-section h2 {
            margin-bottom: 20px;
            color: #333;
            font-size: 1.3em;
        }

        .saved-data-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .saved-data-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }

        .saved-data-item {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .saved-data-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .saved-data-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }

        .saved-data-summary {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 12px;
        }

        .saved-data-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.8em;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-view {
            background: #007bff;
            color: white;
        }

        .btn-view:hover {
            background: #0056b3;
        }

        .btn-export {
            background: #28a745;
            color: white;
        }

        .btn-export:hover {
            background: #1e7e34;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
        }

        .btn-delete:hover {
            background: #c82333;
        }

        /* é«˜åº¦ãªåˆ†æã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .advanced-analytics-section {
            margin: 30px 0;
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .advanced-analytics-section h2 {
            margin-bottom: 25px;
            color: #333;
            font-size: 1.3em;
        }

        .analytics-controls {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-weight: 500;
            color: #555;
            font-size: 0.9em;
        }

        .filter-group select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9em;
            min-width: 150px;
        }

        .analytics-results {
            display: grid;
            gap: 20px;
        }

        .analytics-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .analytics-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .analytics-card.positive {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
        }

        .analytics-card.warning {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
        }

        .analytics-card.negative {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
        }

        .analytics-card h4 {
            margin: 0 0 10px 0;
            font-size: 0.9em;
            opacity: 0.9;
        }

        .analytics-card .metric-value {
            font-size: 1.8em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .analytics-card .metric-change {
            font-size: 0.8em;
            opacity: 0.8;
        }

        .analytics-chart-container {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .analytics-chart-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .channel-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .channel-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .channel-item.amazon { border-left-color: #ff9900; }
        .channel-item.mercari { border-left-color: #dc143c; }
        .channel-item.rakuten { border-left-color: #bf0000; }
        .channel-item.yahoo { border-left-color: #660099; }

        .channel-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .channel-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .channel-metric {
            text-align: center;
        }

        .channel-metric-label {
            font-size: 0.8em;
            color: #666;
            margin-bottom: 3px;
        }

        .channel-metric-value {
            font-weight: 600;
            color: #333;
        }

        .trend-analysis {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .trend-insights {
            display: grid;
            gap: 15px;
        }

        .insight-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .insight-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }

        .insight-icon.up {
            background: #4CAF50;
        }

        .insight-icon.down {
            background: #f44336;
        }

        .insight-icon.stable {
            background: #2196F3;
        }

        .insight-text {
            color: #333;
            font-size: 0.9em;
        }
        
        
        .monthly-results {
            background: white;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .monthly-results h3 {
            background: #34495e;
            color: white;
            padding: 15px 20px;
            margin: 0;
            font-size: 1.1rem;
        }
        
        .month-item {
            border-bottom: 1px solid #eee;
            padding: 20px;
        }
        
        .month-item:last-child {
            border-bottom: none;
        }
        
        .month-header {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
        }
        
        .month-data {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .data-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .data-label {
            font-weight: 500;
            color: #555;
        }
        
        .data-value {
            font-weight: 600;
            color: #333;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            display: none;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #c3e6cb;
        }

        /* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆå¯¾å¿œ (769px - 1024px) */
        @media (max-width: 1024px) and (min-width: 769px) {
            .container {
                padding: 20px;
            }
            
            .upload-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .summary-cards {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .analytics-controls {
                flex-direction: column;
                gap: 15px;
            }
            
            .filter-group {
                flex-direction: row;
                align-items: center;
                gap: 10px;
            }
            
            .channel-breakdown {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ (768pxä»¥ä¸‹) */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
                max-width: 100%;
            }
            
            .header {
                text-align: center;
                padding: 20px 15px;
            }
            
            .header h1 {
                font-size: 1.8rem;
                margin-bottom: 10px;
            }
            
            .header p {
                font-size: 0.9rem;
                line-height: 1.4;
            }
            
            /* ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
            .upload-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .upload-group {
                padding: 15px;
            }
            
            .upload-group h3 {
                font-size: 1rem;
                margin-bottom: 12px;
            }
            
            .file-upload {
                padding: 15px;
                font-size: 0.9rem;
            }
            
            /* ãƒœã‚¿ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
            .button-section {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }
            
            .btn-primary, .btn-secondary {
                padding: 12px 20px;
                font-size: 0.95rem;
                width: 100%;
            }
            
            /* æœˆé¸æŠã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
            .month-selector {
                width: 100%;
            }
            
            .month-select {
                width: 100%;
                padding: 12px;
                font-size: 1rem;
            }
            
            /* ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ */
            .summary-cards {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .summary-card {
                padding: 20px 15px;
            }
            
            .summary-card h3 {
                font-size: 0.9rem;
                margin-bottom: 8px;
            }
            
            .summary-card .value {
                font-size: 1.5rem;
            }
            
            .summary-card .change-indicator {
                font-size: 0.8rem;
            }
            
            /* ãƒˆãƒ¬ãƒ³ãƒ‰ã‚°ãƒ©ãƒ• */
            .trend-chart {
                height: 150px;
                gap: 6px;
                padding: 15px 0;
            }
            
            .trend-bar-label {
                font-size: 10px;
                bottom: -20px;
            }
            
            .trend-bar-value {
                font-size: 9px;
                top: -25px;
            }
            
            /* æœˆåˆ¥ãƒ‡ãƒ¼ã‚¿ */
            .month-data {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .data-item {
                padding: 12px;
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            
            .data-label {
                font-size: 0.85rem;
            }
            
            .data-value {
                font-size: 0.95rem;
                align-self: flex-end;
            }
            
            /* ä¿å­˜æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ç®¡ç† */
            .saved-data-controls {
                flex-direction: column;
                gap: 12px;
            }
            
            .saved-data-list {
                grid-template-columns: 1fr;
            }
            
            .saved-data-item {
                padding: 15px;
            }
            
            .saved-data-actions {
                flex-direction: column;
                gap: 8px;
            }
            
            .btn-small {
                width: 100%;
                text-align: center;
                padding: 10px;
            }
            
            /* é«˜åº¦ãªåˆ†æã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
            .analytics-controls {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }
            
            .filter-group {
                flex-direction: column;
                gap: 8px;
            }
            
            .filter-group select {
                width: 100%;
                min-width: auto;
            }
            
            .analytics-summary {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .analytics-card {
                padding: 15px;
            }
            
            .analytics-card .metric-value {
                font-size: 1.4rem;
            }
            
            .channel-breakdown {
                grid-template-columns: 1fr;
            }
            
            .channel-item {
                padding: 12px;
            }
            
            .channel-metrics {
                grid-template-columns: 1fr;
                gap: 8px;
                text-align: left;
            }
            
            .insight-item {
                padding: 10px;
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .insight-icon {
                align-self: flex-start;
            }
            
            .insight-text {
                font-size: 0.85rem;
                line-height: 1.4;
            }
        }

        /* å°å‹ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ (480pxä»¥ä¸‹) */
        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            .header {
                padding: 15px 10px;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .header p {
                font-size: 0.8rem;
            }
            
            .upload-group, .saved-data-item, .analytics-card {
                padding: 12px;
            }
            
            .summary-card {
                padding: 15px 12px;
            }
            
            .summary-card .value {
                font-size: 1.3rem;
            }
            
            .trend-chart {
                height: 120px;
                gap: 4px;
            }
            
            .analytics-chart-container, .trend-analysis {
                padding: 15px;
            }
            
            .analytics-chart-title {
                font-size: 1rem;
            }
            
            .channel-name {
                font-size: 0.9rem;
            }
            
            .channel-metric-value {
                font-size: 0.85rem;
            }
        }

        /* æ¨ªå‘ããƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
        @media (max-width: 768px) and (orientation: landscape) {
            .summary-cards {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .analytics-summary {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .channel-breakdown {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .trend-chart {
                height: 120px;
            }
        }

        /* ã‚¿ãƒƒãƒãƒ‡ãƒã‚¤ã‚¹æœ€é©åŒ– */
        @media (pointer: coarse) {
            .btn-primary, .btn-secondary, .btn-small {
                min-height: 44px;
                padding: 12px 16px;
            }
            
            .file-upload {
                min-height: 80px;
                touch-action: manipulation;
            }
            
            .month-select {
                min-height: 44px;
                padding: 12px;
            }
            
            .summary-card, .analytics-card, .saved-data-item {
                touch-action: manipulation;
            }
            
            .trend-bar {
                min-width: 20px;
            }
        }

        /* é«˜è§£åƒåº¦ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤å¯¾å¿œ */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .spinner {
                border-width: 2px;
            }
            
            .trend-bar, .analytics-card, .summary-card {
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            }
        }

        /* ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£: å¤§ããªãƒ•ã‚©ãƒ³ãƒˆè¨­å®šã¸ã®å¯¾å¿œ */
        @media (prefers-reduced-motion: reduce) {
            .summary-card, .analytics-card, .saved-data-item, .trend-bar {
                transition: none;
            }
            
            .spinner {
                animation: none;
            }
        }

        /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œã®æº–å‚™ */
        @media (prefers-color-scheme: dark) {
            /* å°†æ¥ã®ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰å®Ÿè£…æ™‚ã«ä½¿ç”¨ */
        }

        /* ã‚¿ãƒƒãƒãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ */
        .touch-active {
            background-color: #e3f2fd !important;
            transform: scale(0.98);
            transition: all 0.1s ease;
        }

        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã®æ”¹å–„ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(2px);
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* ã‚ªãƒ•ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã®è¡¨ç¤º */
        .offline-indicator {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: #f44336;
            color: white;
            text-align: center;
            padding: 8px;
            font-size: 0.9rem;
            z-index: 10000;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }

        .offline-indicator.show {
            transform: translateY(0);
        }

        /* ãƒ•ã‚©ãƒ¼ã‚«ã‚¹çŠ¶æ…‹ã®æ”¹å–„ */
        .btn-primary:focus, .btn-secondary:focus, .btn-small:focus {
            outline: 2px solid #007bff;
            outline-offset: 2px;
        }

        input:focus, select:focus {
            outline: 2px solid #007bff;
            outline-offset: 1px;
        }

        /* é¸æŠå¯èƒ½ãƒ†ã‚­ã‚¹ãƒˆã®æ”¹å–„ */
        .data-value, .metric-value, .channel-metric-value {
            user-select: text;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Amazonå£²ä¸Šåˆ©ç›Šè¨ˆç®—ã‚·ã‚¹ãƒ†ãƒ </h1>
            <p>è¤‡æ•°ã®Amazonã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨è²©è·¯ã®CSVãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆã—ã€æœˆæ¬¡åˆ©ç›Šã‚’è‡ªå‹•è¨ˆç®—</p>
        </div>
        
        <div class="main-content">
            <div class="month-selection">
                <h2 style="text-align: center; margin-bottom: 20px; color: #333;">å¯¾è±¡æœˆé¸æŠ</h2>
                <div class="month-selector">
                    <select id="target-month" class="month-select">
                        <option value="">æœˆã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                    </select>
                </div>
            </div>
            
            <div class="upload-section">
                <h2 style="text-align: center; margin-bottom: 40px; color: #333;">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
                
                <!-- A-Mã‚¢ã‚«ã‚¦ãƒ³ãƒˆ -->
                <div class="account-section">
                    <div class="account-title">A-M ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</div>
                    <div class="upload-grid">
                        <div class="upload-item" id="upload-makad-a-m" data-file-type="makad-a-m">
                            <h3>ãƒã‚«ãƒ‰å£²ä¸Šãƒ‡ãƒ¼ã‚¿</h3>
                            <input type="file" class="file-input" id="file-makad-a-m" accept=".csv">
                            <label for="file-makad-a-m" class="file-label">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</label>
                            <div class="upload-instruction">ã¾ãŸã¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</div>
                            <div class="file-name" id="name-makad-a-m"></div>
                        </div>
                        
                        <div class="upload-item" id="upload-hanro-a-m" data-file-type="hanro-a-m">
                            <h3>è²©è·¯ãƒ—ãƒ©ã‚¹å£²ä¸Šãƒ‡ãƒ¼ã‚¿</h3>
                            <input type="file" class="file-input" id="file-hanro-a-m" accept=".csv">
                            <label for="file-hanro-a-m" class="file-label">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</label>
                            <div class="upload-instruction">ã¾ãŸã¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</div>
                            <div class="file-name" id="name-hanro-a-m"></div>
                        </div>
                        
                        <div class="upload-item" id="upload-expense-a-m" data-file-type="expense-a-m">
                            <h3>çµŒè²»ãƒ‡ãƒ¼ã‚¿</h3>
                            <input type="file" class="file-input" id="file-expense-a-m" accept=".csv">
                            <label for="file-expense-a-m" class="file-label">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</label>
                            <div class="upload-instruction">ã¾ãŸã¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</div>
                            <div class="file-name" id="name-expense-a-m"></div>
                        </div>
                        
                        <div class="upload-item" id="upload-ad-a-m" data-file-type="ad-a-m">
                            <h3>åºƒå‘Šè²»ãƒ‡ãƒ¼ã‚¿</h3>
                            <input type="file" class="file-input" id="file-ad-a-m" accept=".csv">
                            <label for="file-ad-a-m" class="file-label">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</label>
                            <div class="upload-instruction">ã¾ãŸã¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</div>
                            <div class="file-name" id="name-ad-a-m"></div>
                        </div>
                    </div>
                </div>
                
                <!-- ãƒ¡ãƒ«ã‚«ãƒªã‚·ãƒ§ãƒƒãƒ— -->
                <div class="mercari-section">
                    <div class="account-title">ãƒ¡ãƒ«ã‚«ãƒªã‚·ãƒ§ãƒƒãƒ—</div>
                    <div class="upload-item" id="upload-mercari" data-file-type="mercari">
                        <h3>ãƒ¡ãƒ«ã‚«ãƒªã‚·ãƒ§ãƒƒãƒ—å£²ä¸Šãƒ‡ãƒ¼ã‚¿</h3>
                        <input type="file" class="file-input" id="file-mercari" accept=".csv">
                        <label for="file-mercari" class="file-label">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</label>
                        <div class="upload-instruction">ã¾ãŸã¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</div>
                        <div class="file-name" id="name-mercari"></div>
                    </div>
                </div>
                
                <!-- O-AAã‚¢ã‚«ã‚¦ãƒ³ãƒˆ -->
                <div class="account-section">
                    <div class="account-title">O-AA ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</div>
                    <div class="upload-grid">
                        <div class="upload-item" id="upload-makad-o-aa" data-file-type="makad-o-aa">
                            <h3>ãƒã‚«ãƒ‰å£²ä¸Šãƒ‡ãƒ¼ã‚¿</h3>
                            <input type="file" class="file-input" id="file-makad-o-aa" accept=".csv">
                            <label for="file-makad-o-aa" class="file-label">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</label>
                            <div class="upload-instruction">ã¾ãŸã¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</div>
                            <div class="file-name" id="name-makad-o-aa"></div>
                        </div>
                        
                        <div class="upload-item" id="upload-hanro-o-aa" data-file-type="hanro-o-aa">
                            <h3>è²©è·¯ãƒ—ãƒ©ã‚¹å£²ä¸Šãƒ‡ãƒ¼ã‚¿</h3>
                            <input type="file" class="file-input" id="file-hanro-o-aa" accept=".csv">
                            <label for="file-hanro-o-aa" class="file-label">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</label>
                            <div class="upload-instruction">ã¾ãŸã¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</div>
                            <div class="file-name" id="name-hanro-o-aa"></div>
                        </div>
                        
                        <div class="upload-item" id="upload-expense-o-aa" data-file-type="expense-o-aa">
                            <h3>çµŒè²»ãƒ‡ãƒ¼ã‚¿</h3>
                            <input type="file" class="file-input" id="file-expense-o-aa" accept=".csv">
                            <label for="file-expense-o-aa" class="file-label">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</label>
                            <div class="upload-instruction">ã¾ãŸã¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</div>
                            <div class="file-name" id="name-expense-o-aa"></div>
                        </div>
                        
                        <div class="upload-item" id="upload-ad-o-aa" data-file-type="ad-o-aa">
                            <h3>åºƒå‘Šè²»ãƒ‡ãƒ¼ã‚¿</h3>
                            <input type="file" class="file-input" id="file-ad-o-aa" accept=".csv">
                            <label for="file-ad-o-aa" class="file-label">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</label>
                            <div class="upload-instruction">ã¾ãŸã¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</div>
                            <div class="file-name" id="name-ad-o-aa"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="button-section">
                <button class="btn btn-validate" onclick="validateFiles()">ãƒ•ã‚¡ã‚¤ãƒ«æ¤œè¨¼</button>
                <button class="btn btn-calculate" onclick="calculateProfit()">åˆ©ç›Šè¨ˆç®—ã‚’å®Ÿè¡Œ</button>
            </div>
            
            <div class="saved-months" id="saved-months" style="display: none;">
                <h3>ä¿å­˜æ¸ˆã¿æœˆãƒ‡ãƒ¼ã‚¿</h3>
                <div class="month-grid" id="month-grid">
                    <!-- æœˆã‚«ãƒ¼ãƒ‰ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                </div>
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>å‡¦ç†ä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„...</p>
            </div>
            
            <div id="message-area"></div>
            
            <!-- é«˜åº¦ãªåˆ†æã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="advanced-analytics-section" id="advanced-analytics-section" style="display: none;">
                <h2>è©³ç´°åˆ†æ</h2>
                <div class="analytics-controls">
                    <div class="filter-group">
                        <label>æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼:</label>
                        <select id="period-filter">
                            <option value="all">å…¨æœŸé–“</option>
                            <option value="last3">ç›´è¿‘3ãƒ¶æœˆ</option>
                            <option value="last6">ç›´è¿‘6ãƒ¶æœˆ</option>
                            <option value="custom">ã‚«ã‚¹ã‚¿ãƒ æœŸé–“</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>è²©è·¯ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼:</label>
                        <select id="channel-filter">
                            <option value="all">å…¨è²©è·¯</option>
                            <option value="amazon">Amazonç³»</option>
                            <option value="mercari">ãƒ¡ãƒ«ã‚«ãƒªShops</option>
                            <option value="rakuten">ãƒãƒ³ã‚³+ï¼ˆæ¥½å¤©ï¼‰</option>
                            <option value="yahoo">Yahoo!ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <button type="button" onclick="generateAnalyticsReport()" class="btn-primary">
                            åˆ†æãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
                        </button>
                        <button type="button" onclick="exportAnalyticsData()" class="btn-secondary">
                            åˆ†æãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                        </button>
                    </div>
                </div>
                
                <div class="analytics-results" id="analytics-results">
                    <!-- åˆ†æçµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                </div>
            </div>

            <!-- ä¿å­˜æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="saved-data-section" id="saved-data-section" style="display: none;">
                <h2>ä¿å­˜æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h2>
                <div class="saved-data-controls">
                    <button type="button" onclick="loadSavedDataList()" class="btn-secondary">
                        ãƒªã‚¹ãƒˆæ›´æ–°
                    </button>
                    <button type="button" onclick="exportAllData()" class="btn-secondary">
                        å…¨ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                    </button>
                    <button type="button" onclick="toggleAdvancedAnalytics()" class="btn-primary">
                        è©³ç´°åˆ†æã‚’è¡¨ç¤º
                    </button>
                </div>
                <div class="saved-data-list" id="saved-data-list">
                    <!-- ä¿å­˜æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã®ãƒªã‚¹ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                </div>
            </div>

            <div class="results-section" id="results">
                <h2 style="margin-bottom: 30px; color: #333;">è¨ˆç®—çµæœ</h2>
                
                <div class="summary-cards" id="summary-cards">
                    <!-- ã‚µãƒãƒªãƒ¼æƒ…å ±ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                </div>
                
                <div class="trend-section" id="trend-section" style="display: none;">
                    <h3>å£²ä¸Šãƒˆãƒ¬ãƒ³ãƒ‰</h3>
                    <div class="trend-chart" id="trend-chart">
                        <!-- ãƒˆãƒ¬ãƒ³ãƒ‰ã‚°ãƒ©ãƒ•ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                    </div>
                </div>
                
                <!-- çµŒè²»ãƒ»åºƒå‘Šè²»è©³ç´°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="expense-detail-section" id="expense-detail-section" style="margin: 30px 0;">
                    <h3 style="color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px;">çµŒè²»ãƒ»åºƒå‘Šè²» è©³ç´°å†…è¨³</h3>
                    
                    <!-- çµŒè²»è©³ç´° -->
                    <div class="expense-breakdown" style="margin: 20px 0;">
                        <h4 style="color: #34495e; margin-bottom: 15px;">ğŸ“Š çµŒè²»å†…è¨³</h4>
                        <div id="expense-details" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                            <!-- çµŒè²»è©³ç´°ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                        </div>
                    </div>
                    
                    <!-- åºƒå‘Šè²»è©³ç´° -->
                    <div class="ad-breakdown" style="margin: 20px 0;">
                        <h4 style="color: #34495e; margin-bottom: 15px;">ğŸ“£ åºƒå‘Šè²»å†…è¨³</h4>
                        <div id="ad-details" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                            <!-- åºƒå‘Šè²»è©³ç´°ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                        </div>
                    </div>
                    
                    <!-- æ”¯å‡ºã‚µãƒãƒªãƒ¼ -->
                    <div class="expense-summary" style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                        <h4 style="color: #2c3e50; margin-bottom: 15px;">ğŸ’° æ”¯å‡ºã‚µãƒãƒªãƒ¼</h4>
                        <div id="expense-summary-content" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <!-- æ”¯å‡ºã‚µãƒãƒªãƒ¼ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                        </div>
                    </div>
                </div>
                
                <div class="monthly-results">
                    <h3>æœˆåˆ¥è©³ç´°çµæœ</h3>
                    <div id="monthly-data">
                        <!-- æœˆåˆ¥ãƒ‡ãƒ¼ã‚¿ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let monthsData = [];
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«æœˆãƒªã‚¹ãƒˆã‚’å–å¾—
        document.addEventListener('DOMContentLoaded', function() {
            loadMonthsList();
            loadSavedDataList();
            initializeMobileOptimizations();
        });

        // ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ–ã®åˆæœŸåŒ–
        function initializeMobileOptimizations() {
            // PWAå¯¾å¿œ
            addInstallPrompt();
            
            // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã®æœ€é©åŒ–
            optimizeTouchEvents();
            
            // ç”»é¢å›è»¢å¯¾å¿œ
            handleOrientationChange();
            
            // ãƒ¢ãƒã‚¤ãƒ«ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å¯¾å¿œ
            handleMobileKeyboard();
        }

        // PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
        let deferredPrompt;
        function addInstallPrompt() {
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                
                // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºï¼ˆå°†æ¥ã®æ©Ÿèƒ½ï¼‰
                console.log('PWA ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¯èƒ½');
            });
        }

        // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã®æœ€é©åŒ–
        function optimizeTouchEvents() {
            // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚¨ãƒªã‚¢ã®ã‚¿ãƒƒãƒå¯¾å¿œå¼·åŒ–
            const dropAreas = document.querySelectorAll('.file-upload');
            
            dropAreas.forEach(area => {
                area.addEventListener('touchstart', function(e) {
                    this.classList.add('touch-active');
                }, { passive: true });
                
                area.addEventListener('touchend', function(e) {
                    this.classList.remove('touch-active');
                    
                    // ã‚¿ãƒƒãƒå¾Œã«ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ã
                    if (e.changedTouches.length === 1) {
                        const input = this.querySelector('input[type="file"]');
                        if (input) {
                            input.click();
                        }
                    }
                }, { passive: true });
            });
            
            // ã‚«ãƒ¼ãƒ‰ã®ã‚¿ãƒƒãƒãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
            const cards = document.querySelectorAll('.summary-card, .analytics-card, .saved-data-item');
            cards.forEach(card => {
                card.addEventListener('touchstart', function() {
                    this.style.transform = 'scale(0.98)';
                }, { passive: true });
                
                card.addEventListener('touchend', function() {
                    this.style.transform = '';
                }, { passive: true });
            });
        }

        // ç”»é¢å›è»¢å¯¾å¿œ
        function handleOrientationChange() {
            window.addEventListener('orientationchange', function() {
                setTimeout(() => {
                    // ãƒˆãƒ¬ãƒ³ãƒ‰ã‚°ãƒ©ãƒ•ã®å†æç”»
                    const trendSection = document.getElementById('trend-section');
                    if (trendSection && trendSection.style.display !== 'none') {
                        // ç¾åœ¨è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹çµæœãƒ‡ãƒ¼ã‚¿ã§å†æç”»
                        const resultsSection = document.getElementById('results');
                        if (resultsSection && resultsSection.style.display !== 'none') {
                            // ç°¡å˜ãªå†æç”»ãƒˆãƒªã‚¬ãƒ¼
                            window.dispatchEvent(new Event('resize'));
                        }
                    }
                }, 500);
            });
        }

        // ãƒ¢ãƒã‚¤ãƒ«ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å¯¾å¿œ
        function handleMobileKeyboard() {
            const viewport = document.querySelector('meta[name=viewport]');
            const originalContent = viewport.content;
            
            // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã«ã‚ºãƒ¼ãƒ ã‚’é˜²ã
            const inputs = document.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.addEventListener('focus', () => {
                    viewport.content = 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no';
                });
                
                input.addEventListener('blur', () => {
                    viewport.content = originalContent;
                });
            });
        }

        // ãƒãƒ¼ãƒãƒ£ãƒ«ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å¯¾å¿œ
        if ('visualViewport' in window) {
            window.visualViewport.addEventListener('resize', () => {
                const keyboardHeight = window.innerHeight - window.visualViewport.height;
                if (keyboardHeight > 150) {
                    // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹
                    document.body.style.paddingBottom = keyboardHeight + 'px';
                } else {
                    document.body.style.paddingBottom = '';
                }
            });
        }

        // æ¥ç¶šçŠ¶æ…‹ã®ç›£è¦–
        function monitorConnection() {
            function updateConnectionStatus() {
                const status = navigator.onLine ? 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³' : 'ã‚ªãƒ•ãƒ©ã‚¤ãƒ³';
                if (!navigator.onLine) {
                    showMessage('ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸã€‚ä¸€éƒ¨ã®æ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚', 'error');
                }
            }
            
            window.addEventListener('online', updateConnectionStatus);
            window.addEventListener('offline', updateConnectionStatus);
        }

        // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–
        function monitorPerformance() {
            if ('performance' in window) {
                window.addEventListener('load', () => {
                    setTimeout(() => {
                        const loadTime = performance.timing.loadEventEnd - performance.timing.navigationStart;
                        if (loadTime > 5000) {
                            console.warn('ãƒšãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿ãŒé…ã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™:', loadTime + 'ms');
                        }
                    }, 0);
                });
            }
        }

        // ã‚¨ãƒ©ãƒ¼å‡¦ç†ã®æ”¹å–„
        window.addEventListener('error', function(e) {
            console.error('JavaScriptã‚¨ãƒ©ãƒ¼:', e.error);
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            if (e.error && e.error.message) {
                showMessage('äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'error');
            }
        });

        // åˆæœŸåŒ–å®Ÿè¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            monitorConnection();
            monitorPerformance();
        });
        
        // æœˆãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿
        async function loadMonthsList() {
            try {
                const response = await fetch('/api/months');
                const result = await response.json();
                
                if (result.success) {
                    monthsData = result.months;
                    populateMonthSelect();
                    displaySavedMonths();
                } else {
                    showMessage('æœˆãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            } catch (error) {
                showMessage(`æœˆãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        // æœˆé¸æŠã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’è¨­å®š
        function populateMonthSelect() {
            const select = document.getElementById('target-month');
            select.innerHTML = '<option value="">æœˆã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
            
            monthsData.forEach(month => {
                const option = document.createElement('option');
                option.value = month.key;
                option.textContent = month.display + (month.has_data ? ' (ä¿å­˜æ¸ˆã¿)' : '');
                select.appendChild(option);
            });
        }
        
        // ä¿å­˜æ¸ˆã¿æœˆãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
        function displaySavedMonths() {
            const savedMonths = monthsData.filter(month => month.has_data);
            const savedMonthsSection = document.getElementById('saved-months');
            const monthGrid = document.getElementById('month-grid');
            
            if (savedMonths.length > 0) {
                savedMonthsSection.style.display = 'block';
                monthGrid.innerHTML = '';
                
                savedMonths.forEach(month => {
                    const card = document.createElement('div');
                    card.className = 'month-card has-data';
                    card.onclick = () => viewMonthData(month.key);
                    
                    card.innerHTML = `
                        <div class="month-card-title">${month.display}</div>
                        <div class="month-card-status">ãƒ‡ãƒ¼ã‚¿ã‚ã‚Š</div>
                    `;
                    
                    monthGrid.appendChild(card);
                });
            } else {
                savedMonthsSection.style.display = 'none';
            }
        }
        
        // æœˆãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
        async function viewMonthData(monthKey) {
            try {
                const response = await fetch(`/api/months/${monthKey}`);
                const result = await response.json();
                
                if (result.success) {
                    // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
                    const mockResult = {
                        spreadsheet_data: result.data.spreadsheet_data,
                        summary: {
                            total_months: 1,
                            total_sales: result.data.spreadsheet_data.reduce((sum, row) => sum + row['å£²ä¸Šé«˜åˆè¨ˆ'], 0),
                            total_profit: result.data.spreadsheet_data.reduce((sum, row) => sum + row['å£²ä¸Šç·åˆ©ç›Š'], 0),
                            average_profit_rate: 0
                        }
                    };
                    
                    mockResult.summary.average_profit_rate = mockResult.summary.total_sales > 0 
                        ? (mockResult.summary.total_profit / mockResult.summary.total_sales * 100) 
                        : 0;
                    
                    displayResults(mockResult);
                    showMessage(`${result.display_name}ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ`, 'success');
                } else {
                    showMessage(result.error, 'error');
                }
            } catch (error) {
                showMessage(`ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        // ä¿å­˜æ¸ˆã¿æœˆãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
        function loadSavedMonths() {
            // ã“ã®é–¢æ•°ã¯loadMonthsList()ã§ä¸€ç·’ã«å‡¦ç†ã•ã‚Œã‚‹ãŸã‚ã€ç©ºã®ã¾ã¾ã«ã—ã¦ãŠã
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå‡¦ç†
        function handleFileSelect(file, uploadItem) {
            const fileInput = uploadItem.querySelector('.file-input');
            const fileName = uploadItem.querySelector('.file-name');
            
            // ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ãƒã‚§ãƒƒã‚¯
            if (file && file.name.toLowerCase().endsWith('.csv')) {
                // FileListã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¦inputã«è¨­å®š
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                fileInput.files = dataTransfer.files;
                
                fileName.textContent = file.name;
                uploadItem.classList.add('has-file');
                uploadItem.classList.remove('drag-over');
            } else {
                showMessage('CSVãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯èƒ½ã§ã™ã€‚', 'error');
                uploadItem.classList.remove('drag-over');
            }
        }
        
        // é€šå¸¸ã®ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå‡¦ç†
        document.querySelectorAll('.file-input').forEach(input => {
            input.addEventListener('change', function() {
                const uploadItem = this.closest('.upload-item');
                const fileName = uploadItem.querySelector('.file-name');
                
                if (this.files.length > 0) {
                    fileName.textContent = this.files[0].name;
                    uploadItem.classList.add('has-file');
                } else {
                    fileName.textContent = '';
                    uploadItem.classList.remove('has-file');
                }
            });
        });
        
        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†
        document.querySelectorAll('.upload-item').forEach(uploadItem => {
            // ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ¼ãƒãƒ¼æ™‚ã®å‡¦ç†
            uploadItem.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.classList.add('drag-over');
            });
            
            // ãƒ‰ãƒ©ãƒƒã‚°ãƒªãƒ¼ãƒ–æ™‚ã®å‡¦ç†
            uploadItem.addEventListener('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                // å­è¦ç´ ã‹ã‚‰å‡ºãŸå ´åˆã¯ç„¡è¦–
                if (!this.contains(e.relatedTarget)) {
                    this.classList.remove('drag-over');
                }
            });
            
            // ãƒ‰ãƒ­ãƒƒãƒ—æ™‚ã®å‡¦ç†
            uploadItem.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect(files[0], this);
                }
            });
            
            // ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†ï¼ˆæ—¢å­˜ã®ãƒ©ãƒ™ãƒ«ã‚¯ãƒªãƒƒã‚¯ã¨åŒã˜å‹•ä½œï¼‰
            uploadItem.addEventListener('click', function(e) {
                // ãƒ©ãƒ™ãƒ«ã‚„inputãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸå ´åˆã¯ç„¡è¦–
                if (e.target.tagName === 'LABEL' || e.target.tagName === 'INPUT') {
                    return;
                }
                
                const fileInput = this.querySelector('.file-input');
                fileInput.click();
            });
        });
        
        // ãƒšãƒ¼ã‚¸å…¨ä½“ã§ã®ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚’ç„¡åŠ¹åŒ–ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œã‚’é˜²ãï¼‰
        document.addEventListener('dragover', function(e) {
            e.preventDefault();
        });
        
        document.addEventListener('drop', function(e) {
            e.preventDefault();
        });

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        function showMessage(message, type = 'info') {
            const messageArea = document.getElementById('message-area');
            const className = type === 'error' ? 'error' : 'success';
            messageArea.innerHTML = `<div class="${className}">${message}</div>`;
            setTimeout(() => {
                messageArea.innerHTML = '';
            }, 5000);
        }

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«æ¤œè¨¼
        async function validateFiles() {
            const formData = new FormData();
            let hasFiles = false;

            // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ FormData ã«è¿½åŠ 
            const fileInputs = [
                'file-makad-a-m', 'file-hanro-a-m', 'file-expense-a-m', 'file-ad-a-m',
                'file-mercari',
                'file-makad-o-aa', 'file-hanro-o-aa', 'file-expense-o-aa', 'file-ad-o-aa'
            ];

            fileInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input.files.length > 0) {
                    const key = inputId.replace('file-', '').replaceAll('-', '_');
                    formData.append(key, input.files[0]);
                    hasFiles = true;
                }
            });

            if (!hasFiles) {
                showMessage('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'error');
                return;
            }

            showLoading(true);

            try {
                const response = await fetch('/api/profit/validate', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    let message = 'ãƒ•ã‚¡ã‚¤ãƒ«æ¤œè¨¼ãŒå®Œäº†ã—ã¾ã—ãŸã€‚\\n\\n';
                    Object.entries(result.validation_results).forEach(([key, validation]) => {
                        message += `${key}: ${validation.valid ? 'âœ… æ­£å¸¸' : 'âŒ ã‚¨ãƒ©ãƒ¼'}\\n`;
                        if (!validation.valid) {
                            message += `ã‚¨ãƒ©ãƒ¼å†…å®¹: ${validation.error}\\n`;
                        }
                    });
                    showMessage(message, 'success');
                } else {
                    showMessage(`æ¤œè¨¼ã‚¨ãƒ©ãƒ¼: ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage(`é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // åˆ©ç›Šè¨ˆç®—å®Ÿè¡Œ
        async function calculateProfit() {
            const targetMonth = document.getElementById('target-month').value;
            if (!targetMonth) {
                showMessage('å¯¾è±¡æœˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'error');
                return;
            }
            
            const formData = new FormData();
            let hasFiles = false;

            // å¯¾è±¡æœˆã‚’è¿½åŠ 
            formData.append('target_month', targetMonth);

            // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ FormData ã«è¿½åŠ 
            const fileInputs = [
                'file-makad-a-m', 'file-hanro-a-m', 'file-expense-a-m', 'file-ad-a-m',
                'file-mercari',
                'file-makad-o-aa', 'file-hanro-o-aa', 'file-expense-o-aa', 'file-ad-o-aa'
            ];

            fileInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input.files.length > 0) {
                    const key = inputId.replace('file-', '').replaceAll('-', '_');
                    formData.append(key, input.files[0]);
                    hasFiles = true;
                }
            });

            if (!hasFiles) {
                showMessage('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'error');
                return;
            }

            showLoading(true);

            try {
                const response = await fetch('/api/profit/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›
                if (result.debug_csv_info) {
                    console.log('=== CSVãƒ‡ãƒãƒƒã‚°æƒ…å ± ===');
                    for (const [key, info] of Object.entries(result.debug_csv_info)) {
                        console.log(`\n${key}:`);
                        console.log('ã‚«ãƒ©ãƒ å:', info.columns);
                        console.log('ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿:', info.sample_row);
                    }
                }

                if (result.success) {
                    showMessage(result.message, 'success');
                    displayResults(result);
                    // æœˆãƒªã‚¹ãƒˆã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
                    await loadMonthsList();
                } else {
                    showMessage(`è¨ˆç®—ã‚¨ãƒ©ãƒ¼: ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage(`é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // çµŒè²»ãƒ»åºƒå‘Šè²»ã®è©³ç´°è¡¨ç¤ºé–¢æ•°
        function displayExpenseDetails(result) {
            const expenseDetails = document.getElementById('expense-details');
            const adDetails = document.getElementById('ad-details');
            const expenseSummary = document.getElementById('expense-summary-content');
            
            // çµŒè²»ã¨åºƒå‘Šè²»ã®ãƒ‡ãƒ¼ã‚¿ã‚’é›†è¨ˆ
            let expenseData = {
                'A-M': {
                    'Amazonæ‰‹æ•°æ–™': 0, 'FBAæ‰‹æ•°æ–™': 0, 'é…é€æ–™': 0, 
                    'ãƒã‚¤ãƒ³ãƒˆè²»ç”¨': 0, 'ãã®ä»–çµŒè²»': 0, 'åˆè¨ˆ': 0
                },
                'O-AA': {
                    'Amazonæ‰‹æ•°æ–™': 0, 'FBAæ‰‹æ•°æ–™': 0, 'é…é€æ–™': 0,
                    'ãƒã‚¤ãƒ³ãƒˆè²»ç”¨': 0, 'ãã®ä»–çµŒè²»': 0, 'åˆè¨ˆ': 0
                }
            };
            
            let adData = {
                'A-M': {
                    'SPåºƒå‘Š': 0, 'åˆè¨ˆ': 0
                },
                'O-AA': {
                    'SPåºƒå‘Š': 0, 'åˆè¨ˆ': 0
                }
            };
            
            // ãƒ‡ãƒ¼ã‚¿ã‚’é›†è¨ˆ
            if (result.spreadsheet_data && result.spreadsheet_data.length > 0) {
                result.spreadsheet_data.forEach(row => {
                    // çµŒè²»ãƒ‡ãƒ¼ã‚¿ã®é›†è¨ˆ
                    Object.keys(row).forEach(key => {
                        if (key.includes('Amazonæ‰‹æ•°æ–™_A-M')) expenseData['A-M']['Amazonæ‰‹æ•°æ–™'] += row[key] || 0;
                        if (key.includes('FBAæ‰‹æ•°æ–™_A-M')) expenseData['A-M']['FBAæ‰‹æ•°æ–™'] += row[key] || 0;
                        if (key.includes('é…é€æ–™_A-M')) expenseData['A-M']['é…é€æ–™'] += row[key] || 0;
                        if (key.includes('ãƒã‚¤ãƒ³ãƒˆè²»ç”¨_A-M')) expenseData['A-M']['ãƒã‚¤ãƒ³ãƒˆè²»ç”¨'] += row[key] || 0;
                        if (key.includes('ãã®ä»–çµŒè²»_A-M')) expenseData['A-M']['ãã®ä»–çµŒè²»'] += row[key] || 0;
                        if (key.includes('çµŒè²»åˆè¨ˆ_A-M')) expenseData['A-M']['åˆè¨ˆ'] += row[key] || 0;
                        
                        if (key.includes('Amazonæ‰‹æ•°æ–™_O-AA')) expenseData['O-AA']['Amazonæ‰‹æ•°æ–™'] += row[key] || 0;
                        if (key.includes('FBAæ‰‹æ•°æ–™_O-AA')) expenseData['O-AA']['FBAæ‰‹æ•°æ–™'] += row[key] || 0;
                        if (key.includes('é…é€æ–™_O-AA')) expenseData['O-AA']['é…é€æ–™'] += row[key] || 0;
                        if (key.includes('ãƒã‚¤ãƒ³ãƒˆè²»ç”¨_O-AA')) expenseData['O-AA']['ãƒã‚¤ãƒ³ãƒˆè²»ç”¨'] += row[key] || 0;
                        if (key.includes('ãã®ä»–çµŒè²»_O-AA')) expenseData['O-AA']['ãã®ä»–çµŒè²»'] += row[key] || 0;
                        if (key.includes('çµŒè²»åˆè¨ˆ_O-AA')) expenseData['O-AA']['åˆè¨ˆ'] += row[key] || 0;
                        
                        // åºƒå‘Šè²»ãƒ‡ãƒ¼ã‚¿ã®é›†è¨ˆ
                        if (key.includes('ã‚¹ãƒãƒ³ã‚µãƒ¼ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆåºƒå‘Š_A-M')) adData['A-M']['SPåºƒå‘Š'] += row[key] || 0;
                        if (key.includes('åºƒå‘Šè²»åˆè¨ˆ_A-M')) adData['A-M']['åˆè¨ˆ'] += row[key] || 0;
                        
                        if (key.includes('ã‚¹ãƒãƒ³ã‚µãƒ¼ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆåºƒå‘Š_O-AA')) adData['O-AA']['SPåºƒå‘Š'] += row[key] || 0;
                        if (key.includes('åºƒå‘Šè²»åˆè¨ˆ_O-AA')) adData['O-AA']['åˆè¨ˆ'] += row[key] || 0;
                    });
                });
            }
            
            // çµŒè²»è©³ç´°ã‚’è¡¨ç¤º
            expenseDetails.innerHTML = '';
            ['A-M', 'O-AA'].forEach(account => {
                const card = document.createElement('div');
                card.style.cssText = 'background: white; border: 1px solid #ddd; border-radius: 8px; padding: 15px;';
                card.innerHTML = `
                    <h5 style="color: #2c3e50; margin-bottom: 10px;">${account}ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</h5>
                    <table style="width: 100%; font-size: 14px;">
                        <tr><td>Amazonæ‰‹æ•°æ–™:</td><td style="text-align: right;">Â¥${(expenseData[account]['Amazonæ‰‹æ•°æ–™'] || 0).toLocaleString()}</td></tr>
                        <tr><td>FBAæ‰‹æ•°æ–™:</td><td style="text-align: right;">Â¥${(expenseData[account]['FBAæ‰‹æ•°æ–™'] || 0).toLocaleString()}</td></tr>
                        <tr><td>é…é€æ–™:</td><td style="text-align: right;">Â¥${(expenseData[account]['é…é€æ–™'] || 0).toLocaleString()}</td></tr>
                        <tr><td>ãƒã‚¤ãƒ³ãƒˆè²»ç”¨:</td><td style="text-align: right;">Â¥${(expenseData[account]['ãƒã‚¤ãƒ³ãƒˆè²»ç”¨'] || 0).toLocaleString()}</td></tr>
                        <tr><td>ãã®ä»–:</td><td style="text-align: right;">Â¥${(expenseData[account]['ãã®ä»–çµŒè²»'] || 0).toLocaleString()}</td></tr>
                        <tr style="border-top: 2px solid #3498db; font-weight: bold;">
                            <td>åˆè¨ˆ:</td><td style="text-align: right; color: #e74c3c;">Â¥${(expenseData[account]['åˆè¨ˆ'] || 0).toLocaleString()}</td>
                        </tr>
                    </table>
                `;
                expenseDetails.appendChild(card);
            });
            
            // åºƒå‘Šè²»è©³ç´°ã‚’è¡¨ç¤º
            adDetails.innerHTML = '';
            ['A-M', 'O-AA'].forEach(account => {
                const card = document.createElement('div');
                card.style.cssText = 'background: white; border: 1px solid #ddd; border-radius: 8px; padding: 15px;';
                card.innerHTML = `
                    <h5 style="color: #2c3e50; margin-bottom: 10px;">${account}ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</h5>
                    <table style="width: 100%; font-size: 14px;">
                        <tr><td>SPåºƒå‘Š:</td><td style="text-align: right;">Â¥${(adData[account]['SPåºƒå‘Š'] || 0).toLocaleString()}</td></tr>
                        <tr style="border-top: 2px solid #3498db; font-weight: bold;">
                            <td>åˆè¨ˆ:</td><td style="text-align: right; color: #e74c3c;">Â¥${(adData[account]['åˆè¨ˆ'] || 0).toLocaleString()}</td>
                        </tr>
                    </table>
                `;
                adDetails.appendChild(card);
            });
            
            // æ”¯å‡ºã‚µãƒãƒªãƒ¼ã‚’è¡¨ç¤º
            const totalExpense = expenseData['A-M']['åˆè¨ˆ'] + expenseData['O-AA']['åˆè¨ˆ'];
            const totalAd = adData['A-M']['åˆè¨ˆ'] + adData['O-AA']['åˆè¨ˆ'];
            const totalCost = totalExpense + totalAd;
            
            expenseSummary.innerHTML = `
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; text-align: center;">
                    <h5 style="color: #856404;">ç·çµŒè²»</h5>
                    <div style="font-size: 24px; font-weight: bold; color: #e74c3c;">Â¥${totalExpense.toLocaleString()}</div>
                </div>
                <div style="background: #d1ecf1; padding: 15px; border-radius: 8px; text-align: center;">
                    <h5 style="color: #0c5460;">ç·åºƒå‘Šè²»</h5>
                    <div style="font-size: 24px; font-weight: bold; color: #e74c3c;">Â¥${totalAd.toLocaleString()}</div>
                </div>
                <div style="background: #f8d7da; padding: 15px; border-radius: 8px; text-align: center;">
                    <h5 style="color: #721c24;">ç·æ”¯å‡º</h5>
                    <div style="font-size: 24px; font-weight: bold; color: #dc3545;">Â¥${totalCost.toLocaleString()}</div>
                </div>
            `;
        }
        
        // çµæœè¡¨ç¤º
        function displayResults(result) {
            // æ”¹å–„ã•ã‚ŒãŸã‚µãƒãƒªãƒ¼è¡¨ç¤º
            const summaryCards = document.getElementById('summary-cards');
            summaryCards.innerHTML = `
                <div class="summary-card months">
                    <h3>å‡¦ç†æœˆæ•°</h3>
                    <div class="value">${result.summary.total_months}</div>
                    <div class="change-indicator change-neutral">ãƒ¶æœˆã®ãƒ‡ãƒ¼ã‚¿</div>
                </div>
                <div class="summary-card sales">
                    <h3>ç·å£²ä¸Š</h3>
                    <div class="value">Â¥${formatLargeNumber(result.summary.total_sales)}</div>
                    <div class="change-indicator change-neutral">å…¨è²©è·¯åˆè¨ˆ</div>
                </div>
                <div class="summary-card profit">
                    <h3>ç·åˆ©ç›Š</h3>
                    <div class="value">Â¥${formatLargeNumber(result.summary.total_profit)}</div>
                    <div class="change-indicator change-positive">åˆ©ç›Šåˆè¨ˆ</div>
                </div>
                <div class="summary-card rate">
                    <h3>å¹³å‡åˆ©ç›Šç‡</h3>
                    <div class="value">${result.summary.average_profit_rate.toFixed(1)}%</div>
                    <div class="change-indicator ${result.summary.average_profit_rate >= 20 ? 'change-positive' : result.summary.average_profit_rate >= 10 ? 'change-neutral' : 'change-negative'}">
                        ${result.summary.average_profit_rate >= 20 ? 'å„ªç§€' : result.summary.average_profit_rate >= 10 ? 'è‰¯å¥½' : 'æ”¹å–„ä½™åœ°ã‚ã‚Š'}
                    </div>
                </div>
            `;

            // çµŒè²»ãƒ»åºƒå‘Šè²»ã®è©³ç´°è¡¨ç¤º
            displayExpenseDetails(result);
            
            // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿è¡¨ç¤º
            const monthlyData = document.getElementById('monthly-data');
            monthlyData.innerHTML = '';
            
            if (result.spreadsheet_data && result.spreadsheet_data.length > 0) {
                // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆå½¢å¼ã§è¡¨ç¤º
                result.spreadsheet_data.forEach(rowData => {
                    const monthItem = document.createElement('div');
                    monthItem.className = 'month-item';
                    
                    // å£²ä¸Šé«˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³
                    const salesItems = [
                        { label: 'Amazonï¼ˆA-Mï¼‰', value: rowData['Amazonï¼ˆA-Mï¼‰'] },
                        { label: 'Amazon2ï¼ˆO-AAï¼‰', value: rowData['Amazon2ï¼ˆO-AAï¼‰'] },
                        { label: 'ãƒ¡ãƒ«ã‚«ãƒªShops', value: rowData['ãƒ¡ãƒ«ã‚«ãƒªShops'] },
                        { label: 'ãƒãƒ³ã‚³+ï¼ˆæ¥½å¤©ï¼‰', value: rowData['ãƒãƒ³ã‚³+ï¼ˆæ¥½å¤©ï¼‰'] },
                        { label: 'Yahoo!ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°', value: rowData['Yahoo!ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°'] },
                        { label: 'ãƒ—ãƒªãƒã‚¢ãƒ—ãƒª', value: rowData['ãƒ—ãƒªãƒã‚¢ãƒ—ãƒª'] }
                    ];
                    
                    // çµŒè²»ã‚»ã‚¯ã‚·ãƒ§ãƒ³
                    const expenseItems = [
                        { label: 'ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ æ‰‹æ•°æ–™_Amazon', value: rowData['ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ æ‰‹æ•°æ–™_Amazon'] },
                        { label: 'ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ æ‰‹æ•°æ–™_Amazon2', value: rowData['ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ æ‰‹æ•°æ–™_Amazon2'] },
                        { label: 'ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ æ‰‹æ•°æ–™_ãƒ¡ãƒ«ã‚«ãƒª', value: rowData['ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ æ‰‹æ•°æ–™_ãƒ¡ãƒ«ã‚«ãƒª'] },
                        { label: 'é‹é€è²»ï¼ˆé€æ–™ï¼‰', value: rowData['é‹é€è²»ï¼ˆé€æ–™ï¼‰'] }
                    ];
                    
                    // åˆ©ç›Šã‚»ã‚¯ã‚·ãƒ§ãƒ³
                    const profitItems = [
                        { label: 'å£²ä¸Šç·åˆ©ç›Š', value: rowData['å£²ä¸Šç·åˆ©ç›Š'] },
                        { label: 'å£²ä¸Šé«˜åˆè¨ˆ', value: rowData['å£²ä¸Šé«˜åˆè¨ˆ'] }
                    ];
                    
                    // HTMLã‚’æ§‹ç¯‰
                    let sectionsHtml = '';
                    
                    // å£²ä¸Šé«˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³
                    const salesHtml = salesItems.filter(item => item.value && item.value > 0)
                        .map(item => `<div class="data-item"><span class="data-label">${item.label}</span><span class="data-value">Â¥${(item.value || 0).toLocaleString()}</span></div>`)
                        .join('');
                    if (salesHtml) {
                        sectionsHtml += `<div class="section-title">å£²ä¸Šé«˜</div>${salesHtml}`;
                    }
                    
                    // çµŒè²»ã‚»ã‚¯ã‚·ãƒ§ãƒ³  
                    const expenseHtml = expenseItems.filter(item => item.value && item.value > 0)
                        .map(item => `<div class="data-item"><span class="data-label">${item.label}</span><span class="data-value">Â¥${(item.value || 0).toLocaleString()}</span></div>`)
                        .join('');
                    if (expenseHtml) {
                        sectionsHtml += `<div class="section-title">çµŒè²»</div>${expenseHtml}`;
                    }
                    
                    // åˆ©ç›Šã‚»ã‚¯ã‚·ãƒ§ãƒ³
                    const profitHtml = profitItems.filter(item => item.value && item.value > 0)
                        .map(item => `<div class="data-item"><span class="data-label">${item.label}</span><span class="data-value">Â¥${(item.value || 0).toLocaleString()}</span></div>`)
                        .join('');
                    if (profitHtml) {
                        sectionsHtml += `<div class="section-title">åˆ©ç›Š</div>${profitHtml}`;
                    }
                    
                    monthItem.innerHTML = `
                        <div class="month-header">${rowData['å¹´æœˆ']}</div>
                        <div class="month-data">${sectionsHtml}</div>
                    `;
                    
                    monthlyData.appendChild(monthItem);
                });
            } else {
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: å¾“æ¥ã®è¡¨ç¤º
                Object.entries(result.results).forEach(([month, data]) => {
                    const monthItem = document.createElement('div');
                    monthItem.className = 'month-item';
                    
                    let dataItems = '';
                    Object.entries(data).forEach(([key, value]) => {
                        if (value > 0) {
                            dataItems += `
                                <div class="data-item">
                                    <span class="data-label">${key}</span>
                                    <span class="data-value">Â¥${value.toLocaleString()}</span>
                                </div>
                            `;
                        }
                    });

                    monthItem.innerHTML = `
                        <div class="month-header">${month}</div>
                        <div class="month-data">${dataItems}</div>
                    `;
                    
                    monthlyData.appendChild(monthItem);
                });
            }

            // ãƒˆãƒ¬ãƒ³ãƒ‰ã‚°ãƒ©ãƒ•ã‚’è¡¨ç¤º
            displayTrendChart(result);
            
            // çµæœã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
            document.getElementById('results').style.display = 'block';
            
            // ä¿å­˜æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ãƒªã‚¹ãƒˆã‚’æ›´æ–°
            loadSavedDataList();
        }
        
        // ãƒˆãƒ¬ãƒ³ãƒ‰ã‚°ãƒ©ãƒ•è¡¨ç¤º
        function displayTrendChart(result) {
            try {
                const trendSection = document.getElementById('trend-section');
                const trendChart = document.getElementById('trend-chart');
                
                if (result.spreadsheet_data && result.spreadsheet_data.length > 1) {
                    trendSection.style.display = 'block';
                    
                    // æœ€å¤§å€¤ã‚’å–å¾—ã—ã¦æ­£è¦åŒ–
                    const salesValues = result.spreadsheet_data.map(row => row['å£²ä¸Šé«˜åˆè¨ˆ'] || 0);
                    const maxSales = Math.max(...salesValues);
                    
                    trendChart.innerHTML = '';
                    
                    result.spreadsheet_data.forEach(rowData => {
                        const sales = rowData['å£²ä¸Šé«˜åˆè¨ˆ'] || 0;
                        const height = maxSales > 0 ? Math.max((sales / maxSales * 100), 5) : 10;
                        
                        const bar = document.createElement('div');
                        bar.className = 'trend-bar';
                        bar.style.height = height + '%';
                        
                        const monthDisplay = (rowData['å¹´æœˆ'] || 'æœªè¨­å®š').replace('å¹´', '/').replace('æœˆ', '');
                        
                        bar.innerHTML = `
                            <div class="trend-bar-label">${monthDisplay}</div>
                            <div class="trend-bar-value">Â¥${formatLargeNumber(sales)}</div>
                        `;
                        
                        trendChart.appendChild(bar);
                    });
                } else {
                    trendSection.style.display = 'none';
                }
            } catch (error) {
                console.warn('ãƒˆãƒ¬ãƒ³ãƒ‰ã‚°ãƒ©ãƒ•è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('trend-section').style.display = 'none';
            }
        }

        // æ•°å€¤ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé–¢æ•°
        function formatNumber(num) {
            return new Intl.NumberFormat('ja-JP').format(num);
        }
        
        // å¤§ããªæ•°å€¤ã‚’ç°¡æ½”ã«è¡¨ç¤º
        function formatLargeNumber(num) {
            if (num >= 10000000) {
                return (num / 10000000).toFixed(1) + 'åƒä¸‡';
            } else if (num >= 10000) {
                return (num / 10000).toFixed(1) + 'ä¸‡';
            } else {
                return num.toLocaleString();
            }
        }
        
        // ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ã®ã‚«ãƒ©ãƒ¼ã‚¯ãƒ©ã‚¹ã‚’å–å¾—
        function getPercentageClass(percentage) {
            if (percentage > 0) return 'change-positive';
            if (percentage < 0) return 'change-negative';
            return 'change-neutral';
        }

        // ä¿å­˜æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿
        async function loadSavedDataList() {
            try {
                const response = await fetch('/api/months');
                const result = await response.json();
                
                if (result.success) {
                    const savedMonths = result.months.filter(month => month.has_data);
                    displaySavedDataList(savedMonths);
                    
                    // ä¿å­˜æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
                    const section = document.getElementById('saved-data-section');
                    if (savedMonths.length > 0) {
                        section.style.display = 'block';
                    } else {
                        section.style.display = 'none';
                    }
                } else {
                    showMessage('ä¿å­˜æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            } catch (error) {
                console.error('ä¿å­˜æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ä¿å­˜æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
        function displaySavedDataList(savedMonths) {
            const listContainer = document.getElementById('saved-data-list');
            listContainer.innerHTML = '';
            
            if (savedMonths.length === 0) {
                listContainer.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">ä¿å­˜æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            savedMonths.forEach(month => {
                const item = document.createElement('div');
                item.className = 'saved-data-item';
                
                item.innerHTML = `
                    <div class="saved-data-title">${month.display}</div>
                    <div class="saved-data-summary">ãƒ‡ãƒ¼ã‚¿ä¿å­˜æ¸ˆã¿ (${month.key})</div>
                    <div class="saved-data-actions">
                        <button class="btn-small btn-view" onclick="viewMonthData('${month.key}')">
                            è©³ç´°è¡¨ç¤º
                        </button>
                        <button class="btn-small btn-export" onclick="exportMonthData('${month.key}')">
                            ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                        </button>
                        <button class="btn-small btn-delete" onclick="deleteMonthData('${month.key}')">
                            å‰Šé™¤
                        </button>
                    </div>
                `;
                
                listContainer.appendChild(item);
            });
        }

        // æœˆåˆ¥ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
        async function viewMonthData(monthKey) {
            try {
                showLoading(true);
                const response = await fetch(`/api/months/${monthKey}`);
                const result = await response.json();
                
                if (result.success) {
                    // æ—¢å­˜ã®çµæœè¡¨ç¤ºé–¢æ•°ã‚’ä½¿ç”¨
                    const mockResult = {
                        success: true,
                        message: `${result.display_name}ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ`,
                        target_month: monthKey,
                        results: result.data.results,
                        spreadsheet_data: result.data.spreadsheet_data,
                        summary: {
                            total_months: 1,
                            total_sales: result.data.spreadsheet_data.reduce((sum, row) => sum + (row['å£²ä¸Šé«˜åˆè¨ˆ'] || 0), 0),
                            total_profit: result.data.spreadsheet_data.reduce((sum, row) => sum + (row['å£²ä¸Šç·åˆ©ç›Š'] || 0), 0),
                            average_profit_rate: 0
                        }
                    };
                    
                    // åˆ©ç›Šç‡ã‚’è¨ˆç®—
                    if (mockResult.summary.total_sales > 0) {
                        mockResult.summary.average_profit_rate = (mockResult.summary.total_profit / mockResult.summary.total_sales) * 100;
                    }
                    
                    displayResults(mockResult);
                    showMessage(`${result.display_name}ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ`, 'success');
                } else {
                    showMessage(`ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºã‚¨ãƒ©ãƒ¼: ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage(`ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // æœˆåˆ¥ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        async function exportMonthData(monthKey) {
            try {
                const response = await fetch(`/api/months/${monthKey}/spreadsheet`);
                const result = await response.json();
                
                if (result.success) {
                    // CSVãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
                    const csvData = convertToCSV(result.spreadsheet_data);
                    downloadCSV(csvData, `${monthKey}_ãƒ‡ãƒ¼ã‚¿.csv`);
                    showMessage(`${result.display_name}ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`, 'success');
                } else {
                    showMessage(`ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage(`ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // æœˆåˆ¥ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
        async function deleteMonthData(monthKey) {
            if (!confirm(`${monthKey}ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/months/${monthKey}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                
                if (result.success) {
                    showMessage(result.message, 'success');
                    // ãƒªã‚¹ãƒˆã‚’å†èª­ã¿è¾¼ã¿
                    loadSavedDataList();
                    loadMonthsList();
                } else {
                    showMessage(`å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage(`å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        async function exportAllData() {
            try {
                showLoading(true);
                const response = await fetch('/api/months');
                const result = await response.json();
                
                if (result.success) {
                    const savedMonths = result.months.filter(month => month.has_data);
                    
                    if (savedMonths.length === 0) {
                        showMessage('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                        return;
                    }
                    
                    let allData = [];
                    
                    for (const month of savedMonths) {
                        const monthResponse = await fetch(`/api/months/${month.key}/spreadsheet`);
                        const monthResult = await monthResponse.json();
                        
                        if (monthResult.success) {
                            allData = allData.concat(monthResult.spreadsheet_data);
                        }
                    }
                    
                    if (allData.length > 0) {
                        const csvData = convertToCSV(allData);
                        downloadCSV(csvData, 'å…¨ãƒ‡ãƒ¼ã‚¿_ä¸€æ‹¬ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ.csv');
                        showMessage(`${savedMonths.length}ãƒ¶æœˆåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`, 'success');
                    } else {
                        showMessage('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå¯èƒ½ãªãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                    }
                } else {
                    showMessage(`ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage(`ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // CSVãƒ‡ãƒ¼ã‚¿ã«å¤‰æ›
        function convertToCSV(data) {
            if (!data || data.length === 0) return '';
            
            const headers = Object.keys(data[0]);
            const csvRows = [headers.join(',')];
            
            data.forEach(row => {
                const values = headers.map(header => {
                    const value = row[header];
                    // å€¤ã«æ”¹è¡Œã‚„ã‚«ãƒ³ãƒãŒå«ã¾ã‚Œã‚‹å ´åˆã¯ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã§å›²ã‚€
                    if (typeof value === 'string' && (value.includes(',') || value.includes('\n') || value.includes('"'))) {
                        return `"${value.replace(/"/g, '""')}"`;
                    }
                    return value;
                });
                csvRows.push(values.join(','));
            });
            
            return csvRows.join('\n');
        }

        // CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        function downloadCSV(csvData, filename) {
            const blob = new Blob(['\uFEFF' + csvData], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // é«˜åº¦ãªåˆ†æã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
        function toggleAdvancedAnalytics() {
            const section = document.getElementById('advanced-analytics-section');
            const isVisible = section.style.display !== 'none';
            
            if (isVisible) {
                section.style.display = 'none';
            } else {
                section.style.display = 'block';
                // åˆå›è¡¨ç¤ºæ™‚ã«åˆ†æãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
                if (section.innerHTML.includes('åˆ†æçµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™')) {
                    generateAnalyticsReport();
                }
            }
        }

        // åˆ†æãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
        async function generateAnalyticsReport() {
            try {
                showLoading(true);
                
                // å…¨ã¦ã®ä¿å­˜æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const response = await fetch('/api/months');
                const result = await response.json();
                
                if (!result.success) {
                    showMessage('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                    return;
                }
                
                const savedMonths = result.months.filter(month => month.has_data);
                
                if (savedMonths.length === 0) {
                    document.getElementById('analytics-results').innerHTML = 
                        '<p style="text-align: center; color: #666; padding: 40px;">åˆ†æã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                    return;
                }
                
                // å„æœˆã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                let allMonthData = [];
                for (const month of savedMonths) {
                    const monthResponse = await fetch(`/api/months/${month.key}/spreadsheet`);
                    const monthResult = await monthResponse.json();
                    
                    if (monthResult.success) {
                        allMonthData = allMonthData.concat(monthResult.spreadsheet_data.map(data => ({
                            ...data,
                            monthKey: month.key,
                            displayName: month.display
                        })));
                    }
                }
                
                // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é©ç”¨
                const filteredData = applyAnalyticsFilters(allMonthData);
                
                // åˆ†æçµæœã‚’ç”Ÿæˆ
                const analytics = calculateAnalytics(filteredData);
                
                // çµæœã‚’è¡¨ç¤º
                displayAnalyticsResults(analytics);
                
                showMessage('åˆ†æãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¾ã—ãŸ', 'success');
                
            } catch (error) {
                showMessage(`åˆ†æã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é©ç”¨
        function applyAnalyticsFilters(data) {
            const periodFilter = document.getElementById('period-filter').value;
            const channelFilter = document.getElementById('channel-filter').value;
            
            let filteredData = [...data];
            
            // æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            if (periodFilter !== 'all') {
                const now = new Date();
                let startDate;
                
                if (periodFilter === 'last3') {
                    startDate = new Date(now.getFullYear(), now.getMonth() - 3, 1);
                } else if (periodFilter === 'last6') {
                    startDate = new Date(now.getFullYear(), now.getMonth() - 6, 1);
                }
                
                if (startDate) {
                    filteredData = filteredData.filter(item => {
                        const itemDate = new Date(item.monthKey + '-01');
                        return itemDate >= startDate;
                    });
                }
            }
            
            return filteredData;
        }

        // åˆ†æã‚’è¨ˆç®—
        function calculateAnalytics(data) {
            if (data.length === 0) {
                return null;
            }
            
            // åŸºæœ¬çµ±è¨ˆ
            const totalSales = data.reduce((sum, item) => sum + (item['å£²ä¸Šé«˜åˆè¨ˆ'] || 0), 0);
            const totalProfit = data.reduce((sum, item) => sum + (item['å£²ä¸Šç·åˆ©ç›Š'] || 0), 0);
            const avgProfitRate = totalSales > 0 ? (totalProfit / totalSales) * 100 : 0;
            
            // æœˆå¹³å‡
            const monthlyAvgSales = totalSales / data.length;
            const monthlyAvgProfit = totalProfit / data.length;
            
            // è²©è·¯åˆ¥åˆ†æ
            const channelAnalysis = {
                amazon: {
                    sales: data.reduce((sum, item) => sum + (item['Amazonï¼ˆA-Mï¼‰'] || 0) + (item['Amazon2ï¼ˆO-AAï¼‰'] || 0), 0),
                    fees: data.reduce((sum, item) => sum + (item['ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ æ‰‹æ•°æ–™_Amazon'] || 0) + (item['ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ æ‰‹æ•°æ–™_Amazon2'] || 0), 0)
                },
                mercari: {
                    sales: data.reduce((sum, item) => sum + (item['ãƒ¡ãƒ«ã‚«ãƒªShops'] || 0), 0),
                    fees: data.reduce((sum, item) => sum + (item['ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ æ‰‹æ•°æ–™_ãƒ¡ãƒ«ã‚«ãƒª'] || 0), 0)
                },
                rakuten: {
                    sales: data.reduce((sum, item) => sum + (item['ãƒãƒ³ã‚³+ï¼ˆæ¥½å¤©ï¼‰'] || 0), 0),
                    fees: 0
                },
                yahoo: {
                    sales: data.reduce((sum, item) => sum + (item['Yahoo!ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°'] || 0), 0),
                    fees: 0
                }
            };
            
            // ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ
            const trendAnalysis = calculateTrendAnalysis(data);
            
            // ã‚¤ãƒ³ã‚µã‚¤ãƒˆç”Ÿæˆ
            const insights = generateInsights(data, channelAnalysis, trendAnalysis);
            
            return {
                basic: {
                    totalSales,
                    totalProfit,
                    avgProfitRate,
                    monthlyAvgSales,
                    monthlyAvgProfit,
                    dataPoints: data.length
                },
                channels: channelAnalysis,
                trends: trendAnalysis,
                insights: insights
            };
        }

        // ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æã‚’è¨ˆç®—
        function calculateTrendAnalysis(data) {
            if (data.length < 2) {
                return { trend: 'insufficient_data' };
            }
            
            // æœˆé †ã§ã‚½ãƒ¼ãƒˆ
            const sortedData = data.sort((a, b) => a.monthKey.localeCompare(b.monthKey));
            
            // å£²ä¸Šã®ãƒˆãƒ¬ãƒ³ãƒ‰
            const salesTrend = [];
            const profitTrend = [];
            
            for (let i = 1; i < sortedData.length; i++) {
                const prevSales = sortedData[i-1]['å£²ä¸Šé«˜åˆè¨ˆ'] || 0;
                const currSales = sortedData[i]['å£²ä¸Šé«˜åˆè¨ˆ'] || 0;
                const prevProfit = sortedData[i-1]['å£²ä¸Šç·åˆ©ç›Š'] || 0;
                const currProfit = sortedData[i]['å£²ä¸Šç·åˆ©ç›Š'] || 0;
                
                if (prevSales > 0) {
                    salesTrend.push(((currSales - prevSales) / prevSales) * 100);
                }
                if (prevProfit > 0) {
                    profitTrend.push(((currProfit - prevProfit) / prevProfit) * 100);
                }
            }
            
            const avgSalesTrend = salesTrend.length > 0 ? salesTrend.reduce((a, b) => a + b, 0) / salesTrend.length : 0;
            const avgProfitTrend = profitTrend.length > 0 ? profitTrend.reduce((a, b) => a + b, 0) / profitTrend.length : 0;
            
            return {
                salesTrend: avgSalesTrend,
                profitTrend: avgProfitTrend,
                salesVolatility: calculateVolatility(salesTrend),
                profitVolatility: calculateVolatility(profitTrend)
            };
        }

        // ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚’è¨ˆç®—
        function calculateVolatility(trends) {
            if (trends.length < 2) return 0;
            
            const mean = trends.reduce((a, b) => a + b, 0) / trends.length;
            const variance = trends.reduce((sum, trend) => sum + Math.pow(trend - mean, 2), 0) / trends.length;
            return Math.sqrt(variance);
        }

        // ã‚¤ãƒ³ã‚µã‚¤ãƒˆã‚’ç”Ÿæˆ
        function generateInsights(data, channelAnalysis, trendAnalysis) {
            const insights = [];
            
            // ãƒˆãƒ¬ãƒ³ãƒ‰ã«åŸºã¥ãã‚¤ãƒ³ã‚µã‚¤ãƒˆ
            if (trendAnalysis.salesTrend > 5) {
                insights.push({
                    type: 'up',
                    text: `å£²ä¸ŠãŒå¹³å‡${trendAnalysis.salesTrend.toFixed(1)}%ã®æˆé•·ãƒˆãƒ¬ãƒ³ãƒ‰ã‚’ç¤ºã—ã¦ã„ã¾ã™`
                });
            } else if (trendAnalysis.salesTrend < -5) {
                insights.push({
                    type: 'down',
                    text: `å£²ä¸ŠãŒå¹³å‡${Math.abs(trendAnalysis.salesTrend).toFixed(1)}%ã®ä¸‹é™ãƒˆãƒ¬ãƒ³ãƒ‰ã‚’ç¤ºã—ã¦ã„ã¾ã™`
                });
            } else {
                insights.push({
                    type: 'stable',
                    text: 'å£²ä¸Šã¯å®‰å®šã—ãŸãƒˆãƒ¬ãƒ³ãƒ‰ã‚’ç¶­æŒã—ã¦ã„ã¾ã™'
                });
            }
            
            // è²©è·¯åˆ¥ã‚¤ãƒ³ã‚µã‚¤ãƒˆ
            const channelSales = Object.entries(channelAnalysis).map(([name, data]) => ({
                name,
                sales: data.sales
            })).sort((a, b) => b.sales - a.sales);
            
            if (channelSales[0].sales > 0) {
                const topChannel = channelSales[0];
                const channelNames = {
                    amazon: 'Amazonç³»',
                    mercari: 'ãƒ¡ãƒ«ã‚«ãƒªShops',
                    rakuten: 'ãƒãƒ³ã‚³+ï¼ˆæ¥½å¤©ï¼‰',
                    yahoo: 'Yahoo!ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°'
                };
                
                insights.push({
                    type: 'up',
                    text: `${channelNames[topChannel.name]}ãŒæœ€ã‚‚å£²ä¸Šã®é«˜ã„è²©è·¯ã§ã™ï¼ˆÂ¥${formatLargeNumber(topChannel.sales)}ï¼‰`
                });
            }
            
            // åˆ©ç›Šç‡ã‚¤ãƒ³ã‚µã‚¤ãƒˆ
            const totalSales = data.reduce((sum, item) => sum + (item['å£²ä¸Šé«˜åˆè¨ˆ'] || 0), 0);
            const totalProfit = data.reduce((sum, item) => sum + (item['å£²ä¸Šç·åˆ©ç›Š'] || 0), 0);
            const profitRate = totalSales > 0 ? (totalProfit / totalSales) * 100 : 0;
            
            if (profitRate > 25) {
                insights.push({
                    type: 'up',
                    text: `å„ªç§€ãªåˆ©ç›Šç‡${profitRate.toFixed(1)}%ã‚’ç¶­æŒã—ã¦ã„ã¾ã™`
                });
            } else if (profitRate < 10) {
                insights.push({
                    type: 'down',
                    text: `åˆ©ç›Šç‡${profitRate.toFixed(1)}%ã¯æ”¹å–„ã®ä½™åœ°ãŒã‚ã‚Šã¾ã™`
                });
            }
            
            return insights;
        }

        // åˆ†æçµæœã‚’è¡¨ç¤º
        function displayAnalyticsResults(analytics) {
            const resultsContainer = document.getElementById('analytics-results');
            
            if (!analytics) {
                resultsContainer.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">åˆ†æã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            const { basic, channels, trends, insights } = analytics;
            
            resultsContainer.innerHTML = `
                <div class="analytics-summary">
                    <div class="analytics-card ${basic.avgProfitRate > 20 ? 'positive' : basic.avgProfitRate > 10 ? 'warning' : 'negative'}">
                        <h4>å¹³å‡åˆ©ç›Šç‡</h4>
                        <div class="metric-value">${basic.avgProfitRate.toFixed(1)}%</div>
                        <div class="metric-change">${basic.dataPoints}ãƒ¶æœˆã®ãƒ‡ãƒ¼ã‚¿</div>
                    </div>
                    <div class="analytics-card">
                        <h4>æœˆå¹³å‡å£²ä¸Š</h4>
                        <div class="metric-value">Â¥${formatLargeNumber(basic.monthlyAvgSales)}</div>
                        <div class="metric-change">ç·å£²ä¸Š: Â¥${formatLargeNumber(basic.totalSales)}</div>
                    </div>
                    <div class="analytics-card positive">
                        <h4>æœˆå¹³å‡åˆ©ç›Š</h4>
                        <div class="metric-value">Â¥${formatLargeNumber(basic.monthlyAvgProfit)}</div>
                        <div class="metric-change">ç·åˆ©ç›Š: Â¥${formatLargeNumber(basic.totalProfit)}</div>
                    </div>
                    <div class="analytics-card ${trends.salesTrend > 0 ? 'positive' : trends.salesTrend < 0 ? 'negative' : 'warning'}">
                        <h4>å£²ä¸Šæˆé•·ç‡</h4>
                        <div class="metric-value">${trends.salesTrend > 0 ? '+' : ''}${trends.salesTrend.toFixed(1)}%</div>
                        <div class="metric-change">æœˆå¹³å‡æˆé•·ç‡</div>
                    </div>
                </div>
                
                <div class="analytics-chart-container">
                    <div class="analytics-chart-title">è²©è·¯åˆ¥å£²ä¸Šåˆ†æ</div>
                    <div class="channel-breakdown">
                        <div class="channel-item amazon">
                            <div class="channel-name">Amazonç³»</div>
                            <div class="channel-metrics">
                                <div class="channel-metric">
                                    <div class="channel-metric-label">å£²ä¸Š</div>
                                    <div class="channel-metric-value">Â¥${formatLargeNumber(channels.amazon.sales)}</div>
                                </div>
                                <div class="channel-metric">
                                    <div class="channel-metric-label">æ‰‹æ•°æ–™</div>
                                    <div class="channel-metric-value">Â¥${formatLargeNumber(channels.amazon.fees)}</div>
                                </div>
                            </div>
                        </div>
                        <div class="channel-item mercari">
                            <div class="channel-name">ãƒ¡ãƒ«ã‚«ãƒªShops</div>
                            <div class="channel-metrics">
                                <div class="channel-metric">
                                    <div class="channel-metric-label">å£²ä¸Š</div>
                                    <div class="channel-metric-value">Â¥${formatLargeNumber(channels.mercari.sales)}</div>
                                </div>
                                <div class="channel-metric">
                                    <div class="channel-metric-label">æ‰‹æ•°æ–™</div>
                                    <div class="channel-metric-value">Â¥${formatLargeNumber(channels.mercari.fees)}</div>
                                </div>
                            </div>
                        </div>
                        <div class="channel-item rakuten">
                            <div class="channel-name">ãƒãƒ³ã‚³+ï¼ˆæ¥½å¤©ï¼‰</div>
                            <div class="channel-metrics">
                                <div class="channel-metric">
                                    <div class="channel-metric-label">å£²ä¸Š</div>
                                    <div class="channel-metric-value">Â¥${formatLargeNumber(channels.rakuten.sales)}</div>
                                </div>
                                <div class="channel-metric">
                                    <div class="channel-metric-label">æ‰‹æ•°æ–™</div>
                                    <div class="channel-metric-value">Â¥${formatLargeNumber(channels.rakuten.fees)}</div>
                                </div>
                            </div>
                        </div>
                        <div class="channel-item yahoo">
                            <div class="channel-name">Yahoo!ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°</div>
                            <div class="channel-metrics">
                                <div class="channel-metric">
                                    <div class="channel-metric-label">å£²ä¸Š</div>
                                    <div class="channel-metric-value">Â¥${formatLargeNumber(channels.yahoo.sales)}</div>
                                </div>
                                <div class="channel-metric">
                                    <div class="channel-metric-label">æ‰‹æ•°æ–™</div>
                                    <div class="channel-metric-value">Â¥${formatLargeNumber(channels.yahoo.fees)}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="trend-analysis">
                    <div class="analytics-chart-title">ãƒ“ã‚¸ãƒã‚¹ã‚¤ãƒ³ã‚µã‚¤ãƒˆ</div>
                    <div class="trend-insights">
                        ${insights.map(insight => `
                            <div class="insight-item">
                                <div class="insight-icon ${insight.type}">
                                    ${insight.type === 'up' ? 'â†‘' : insight.type === 'down' ? 'â†“' : 'â†’'}
                                </div>
                                <div class="insight-text">${insight.text}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // åˆ†æãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        async function exportAnalyticsData() {
            try {
                showLoading(true);
                
                // ç¾åœ¨ã®åˆ†æçµæœã‚’å–å¾—
                const response = await fetch('/api/months');
                const result = await response.json();
                
                if (!result.success) {
                    showMessage('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                    return;
                }
                
                const savedMonths = result.months.filter(month => month.has_data);
                let allAnalyticsData = [];
                
                for (const month of savedMonths) {
                    const monthResponse = await fetch(`/api/months/${month.key}/spreadsheet`);
                    const monthResult = await monthResponse.json();
                    
                    if (monthResult.success) {
                        monthResult.spreadsheet_data.forEach(data => {
                            allAnalyticsData.push({
                                æœˆ: data['å¹´æœˆ'],
                                æœŸé–“: data['æœŸé–“'],
                                'Amazonå£²ä¸Š': data['Amazonï¼ˆA-Mï¼‰'],
                                'Amazon2å£²ä¸Š': data['Amazon2ï¼ˆO-AAï¼‰'],
                                'ãƒ¡ãƒ«ã‚«ãƒªShopså£²ä¸Š': data['ãƒ¡ãƒ«ã‚«ãƒªShops'],
                                'ãƒãƒ³ã‚³+å£²ä¸Š': data['ãƒãƒ³ã‚³+ï¼ˆæ¥½å¤©ï¼‰'],
                                'Yahooå£²ä¸Š': data['Yahoo!ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°'],
                                'å£²ä¸Šé«˜åˆè¨ˆ': data['å£²ä¸Šé«˜åˆè¨ˆ'],
                                'å£²ä¸Šç·åˆ©ç›Š': data['å£²ä¸Šç·åˆ©ç›Š'],
                                'åˆ©ç›Šç‡': data['å£²ä¸Šé«˜åˆè¨ˆ'] > 0 ? ((data['å£²ä¸Šç·åˆ©ç›Š'] / data['å£²ä¸Šé«˜åˆè¨ˆ']) * 100).toFixed(2) + '%' : '0%',
                                'å£²ä¸Šå‰æœˆæ¯”': data['å£²ä¸Šå‰æœˆæ¯”'] ? data['å£²ä¸Šå‰æœˆæ¯”'].toFixed(2) + '%' : 'åˆæœˆ',
                                'åˆ©ç›Šå‰æœˆæ¯”': data['åˆ©ç›Šå‰æœˆæ¯”'] ? data['åˆ©ç›Šå‰æœˆæ¯”'].toFixed(2) + '%' : 'åˆæœˆ'
                            });
                        });
                    }
                }
                
                if (allAnalyticsData.length > 0) {
                    const csvData = convertToCSV(allAnalyticsData);
                    const timestamp = new Date().toISOString().slice(0, 10);
                    downloadCSV(csvData, `è©³ç´°åˆ†æãƒ¬ãƒãƒ¼ãƒˆ_${timestamp}.csv`);
                    showMessage('åˆ†æãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ', 'success');
                } else {
                    showMessage('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                }
                
            } catch (error) {
                showMessage(`ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }
    </script>
</body>
</html>