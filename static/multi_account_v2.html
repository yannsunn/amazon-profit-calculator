<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV利益・経費計算ツール（複数アカウント対応版）</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
        }
        .file-input-label {
            transition: all 0.2s ease-in-out;
            background-color: #f9fafb;
        }
        .file-input-label:hover {
            background-color: #f3f4f6;
            border-color: #6366f1;
        }
        .toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 50;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            opacity: 0;
            transition: visibility 0s, opacity 0.5s linear;
        }
        .toast.show {
            visibility: visible;
            opacity: 1;
        }
        .summary-card {
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
        }
        details > summary {
            cursor: pointer;
            list-style: none;
        }
        details > summary::-webkit-details-marker {
            display: none;
        }
        .platform-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .platform-tab {
            padding: 10px 20px;
            background: #f3f4f6;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .platform-tab:hover {
            background: #e5e7eb;
        }
        .platform-tab.active {
            background: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }
        .platform-content {
            display: none;
        }
        .platform-content.active {
            display: block;
        }
        .swap-button {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
            background: #ef4444;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .swap-button:hover {
            background: #dc2626;
            transform: scale(1.05);
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <!-- Swap Button -->
    <button id="swapAccountsBtn" class="swap-button">
        🔄 アカウント1↔2入替
    </button>

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-7xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">CSV 利益・経費計算ツール</h1>
            <p class="mt-2 text-gray-600">各販路のCSVをアップロードして収支を計算します。</p>
        </header>

        <main>
            <!-- Platform Tabs -->
            <div class="platform-tabs">
                <button class="platform-tab active" data-platform="amazon">Amazon</button>
                <button class="platform-tab" data-platform="rakuten">楽天</button>
                <button class="platform-tab" data-platform="yahoo">Yahoo!</button>
                <button class="platform-tab" data-platform="qoo10">Qoo10</button>
                <button class="platform-tab" data-platform="mercari">メルカリShops</button>
            </div>

            <!-- File Upload Section -->
            <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                <h2 class="text-xl font-semibold mb-4 border-b pb-2">1. CSVファイルのアップロード</h2>
                
                <!-- Amazon Content -->
                <div id="amazon-content" class="platform-content active">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-8">
                        <!-- Account 1 -->
                        <div class="p-4 border rounded-lg space-y-4">
                            <h3 class="font-semibold text-lg text-center text-indigo-700">アカウント 1</h3>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">マカドCSV</label>
                                <label for="makadFile1" class="file-input-label flex justify-center w-full px-4 py-4 border-2 border-gray-300 border-dashed rounded-md cursor-pointer">
                                    <div class="text-center"><p id="fileNameMakad1" class="text-sm text-gray-600 font-medium">ファイルを選択</p></div>
                                    <input id="makadFile1" type="file" class="hidden" accept=".csv">
                                </label>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">hanro+ CSV</label>
                                <label for="hanroFile1" class="file-input-label flex justify-center w-full px-4 py-4 border-2 border-gray-300 border-dashed rounded-md cursor-pointer">
                                    <div class="text-center"><p id="fileNameHanro1" class="text-sm text-gray-600 font-medium">ファイルを選択</p></div>
                                    <input id="hanroFile1" type="file" class="hidden" accept=".csv">
                                </label>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Amazon経費CSV</label>
                                <label for="amazonFile1" class="file-input-label flex justify-center w-full px-4 py-4 border-2 border-gray-300 border-dashed rounded-md cursor-pointer">
                                    <div class="text-center"><p id="fileNameAmazon1" class="text-sm text-gray-600 font-medium">ファイルを選択</p></div>
                                    <input id="amazonFile1" type="file" class="hidden" accept=".csv">
                                </label>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Amazon広告CSV</label>
                                <label for="adFile1" class="file-input-label flex justify-center w-full px-4 py-4 border-2 border-gray-300 border-dashed rounded-md cursor-pointer">
                                    <div class="text-center"><p id="fileNameAd1" class="text-sm text-gray-600 font-medium">ファイルを選択</p></div>
                                    <input id="adFile1" type="file" class="hidden" accept=".csv">
                                </label>
                            </div>
                        </div>
                        <!-- Account 2 -->
                        <div class="p-4 border rounded-lg space-y-4">
                            <h3 class="font-semibold text-lg text-center text-teal-700">アカウント 2</h3>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">マカドCSV</label>
                                <label for="makadFile2" class="file-input-label flex justify-center w-full px-4 py-4 border-2 border-gray-300 border-dashed rounded-md cursor-pointer">
                                    <div class="text-center"><p id="fileNameMakad2" class="text-sm text-gray-600 font-medium">ファイルを選択</p></div>
                                    <input id="makadFile2" type="file" class="hidden" accept=".csv">
                                </label>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">hanro+ CSV</label>
                                <label for="hanroFile2" class="file-input-label flex justify-center w-full px-4 py-4 border-2 border-gray-300 border-dashed rounded-md cursor-pointer">
                                    <div class="text-center"><p id="fileNameHanro2" class="text-sm text-gray-600 font-medium">ファイルを選択</p></div>
                                    <input id="hanroFile2" type="file" class="hidden" accept=".csv">
                                </label>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Amazon経費CSV</label>
                                <label for="amazonFile2" class="file-input-label flex justify-center w-full px-4 py-4 border-2 border-gray-300 border-dashed rounded-md cursor-pointer">
                                    <div class="text-center"><p id="fileNameAmazon2" class="text-sm text-gray-600 font-medium">ファイルを選択</p></div>
                                    <input id="amazonFile2" type="file" class="hidden" accept=".csv">
                                </label>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Amazon広告CSV</label>
                                <label for="adFile2" class="file-input-label flex justify-center w-full px-4 py-4 border-2 border-gray-300 border-dashed rounded-md cursor-pointer">
                                    <div class="text-center"><p id="fileNameAd2" class="text-sm text-gray-600 font-medium">ファイルを選択</p></div>
                                    <input id="adFile2" type="file" class="hidden" accept=".csv">
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Rakuten Content -->
                <div id="rakuten-content" class="platform-content">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-8">
                        <!-- Account 1 -->
                        <div class="p-4 border rounded-lg space-y-4">
                            <h3 class="font-semibold text-lg text-center text-indigo-700">アカウント 1</h3>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">楽天売上CSV</label>
                                <label for="rakutenSales1" class="file-input-label flex justify-center w-full px-4 py-4 border-2 border-gray-300 border-dashed rounded-md cursor-pointer">
                                    <div class="text-center"><p id="fileNameRakutenSales1" class="text-sm text-gray-600 font-medium">ファイルを選択</p></div>
                                    <input id="rakutenSales1" type="file" class="hidden" accept=".csv">
                                </label>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">楽天経費CSV</label>
                                <label for="rakutenExpense1" class="file-input-label flex justify-center w-full px-4 py-4 border-2 border-gray-300 border-dashed rounded-md cursor-pointer">
                                    <div class="text-center"><p id="fileNameRakutenExpense1" class="text-sm text-gray-600 font-medium">ファイルを選択</p></div>
                                    <input id="rakutenExpense1" type="file" class="hidden" accept=".csv">
                                </label>
                            </div>
                        </div>
                        <!-- Account 2 -->
                        <div class="p-4 border rounded-lg space-y-4">
                            <h3 class="font-semibold text-lg text-center text-teal-700">アカウント 2</h3>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">楽天売上CSV</label>
                                <label for="rakutenSales2" class="file-input-label flex justify-center w-full px-4 py-4 border-2 border-gray-300 border-dashed rounded-md cursor-pointer">
                                    <div class="text-center"><p id="fileNameRakutenSales2" class="text-sm text-gray-600 font-medium">ファイルを選択</p></div>
                                    <input id="rakutenSales2" type="file" class="hidden" accept=".csv">
                                </label>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">楽天経費CSV</label>
                                <label for="rakutenExpense2" class="file-input-label flex justify-center w-full px-4 py-4 border-2 border-gray-300 border-dashed rounded-md cursor-pointer">
                                    <div class="text-center"><p id="fileNameRakutenExpense2" class="text-sm text-gray-600 font-medium">ファイルを選択</p></div>
                                    <input id="rakutenExpense2" type="file" class="hidden" accept=".csv">
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Yahoo Content -->
                <div id="yahoo-content" class="platform-content">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-8">
                        <!-- Account 1 -->
                        <div class="p-4 border rounded-lg space-y-4">
                            <h3 class="font-semibold text-lg text-center text-indigo-700">アカウント 1</h3>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Yahoo!売上CSV</label>
                                <label for="yahooSales1" class="file-input-label flex justify-center w-full px-4 py-4 border-2 border-gray-300 border-dashed rounded-md cursor-pointer">
                                    <div class="text-center"><p id="fileNameYahooSales1" class="text-sm text-gray-600 font-medium">ファイルを選択</p></div>
                                    <input id="yahooSales1" type="file" class="hidden" accept=".csv">
                                </label>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Yahoo!経費CSV</label>
                                <label for="yahooExpense1" class="file-input-label flex justify-center w-full px-4 py-4 border-2 border-gray-300 border-dashed rounded-md cursor-pointer">
                                    <div class="text-center"><p id="fileNameYahooExpense1" class="text-sm text-gray-600 font-medium">ファイルを選択</p></div>
                                    <input id="yahooExpense1" type="file" class="hidden" accept=".csv">
                                </label>
                            </div>
                        </div>
                        <!-- Account 2 -->
                        <div class="p-4 border rounded-lg space-y-4">
                            <h3 class="font-semibold text-lg text-center text-teal-700">アカウント 2</h3>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Yahoo!売上CSV</label>
                                <label for="yahooSales2" class="file-input-label flex justify-center w-full px-4 py-4 border-2 border-gray-300 border-dashed rounded-md cursor-pointer">
                                    <div class="text-center"><p id="fileNameYahooSales2" class="text-sm text-gray-600 font-medium">ファイルを選択</p></div>
                                    <input id="yahooSales2" type="file" class="hidden" accept=".csv">
                                </label>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Yahoo!経費CSV</label>
                                <label for="yahooExpense2" class="file-input-label flex justify-center w-full px-4 py-4 border-2 border-gray-300 border-dashed rounded-md cursor-pointer">
                                    <div class="text-center"><p id="fileNameYahooExpense2" class="text-sm text-gray-600 font-medium">ファイルを選択</p></div>
                                    <input id="yahooExpense2" type="file" class="hidden" accept=".csv">
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Qoo10 Content -->
                <div id="qoo10-content" class="platform-content">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-8">
                        <!-- Account 1 -->
                        <div class="p-4 border rounded-lg space-y-4">
                            <h3 class="font-semibold text-lg text-center text-indigo-700">アカウント 1</h3>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Qoo10売上CSV</label>
                                <label for="qoo10Sales1" class="file-input-label flex justify-center w-full px-4 py-4 border-2 border-gray-300 border-dashed rounded-md cursor-pointer">
                                    <div class="text-center"><p id="fileNameQoo10Sales1" class="text-sm text-gray-600 font-medium">ファイルを選択</p></div>
                                    <input id="qoo10Sales1" type="file" class="hidden" accept=".csv">
                                </label>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Qoo10経費CSV</label>
                                <label for="qoo10Expense1" class="file-input-label flex justify-center w-full px-4 py-4 border-2 border-gray-300 border-dashed rounded-md cursor-pointer">
                                    <div class="text-center"><p id="fileNameQoo10Expense1" class="text-sm text-gray-600 font-medium">ファイルを選択</p></div>
                                    <input id="qoo10Expense1" type="file" class="hidden" accept=".csv">
                                </label>
                            </div>
                        </div>
                        <!-- Account 2 -->
                        <div class="p-4 border rounded-lg space-y-4">
                            <h3 class="font-semibold text-lg text-center text-teal-700">アカウント 2</h3>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Qoo10売上CSV</label>
                                <label for="qoo10Sales2" class="file-input-label flex justify-center w-full px-4 py-4 border-2 border-gray-300 border-dashed rounded-md cursor-pointer">
                                    <div class="text-center"><p id="fileNameQoo10Sales2" class="text-sm text-gray-600 font-medium">ファイルを選択</p></div>
                                    <input id="qoo10Sales2" type="file" class="hidden" accept=".csv">
                                </label>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Qoo10経費CSV</label>
                                <label for="qoo10Expense2" class="file-input-label flex justify-center w-full px-4 py-4 border-2 border-gray-300 border-dashed rounded-md cursor-pointer">
                                    <div class="text-center"><p id="fileNameQoo10Expense2" class="text-sm text-gray-600 font-medium">ファイルを選択</p></div>
                                    <input id="qoo10Expense2" type="file" class="hidden" accept=".csv">
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Mercari Content -->
                <div id="mercari-content" class="platform-content">
                    <div class="p-4 border rounded-lg space-y-4 max-w-md mx-auto">
                        <h3 class="font-semibold text-lg text-center text-rose-700">メルカリShops アカウント</h3>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">メルカリShops CSV</label>
                            <label for="mercariFile" class="file-input-label flex justify-center w-full px-4 py-4 border-2 border-gray-300 border-dashed rounded-md cursor-pointer">
                                <div class="text-center"><p id="fileNameMercari" class="text-sm text-gray-600 font-medium">ファイルを選択</p></div>
                                <input id="mercariFile" type="file" class="hidden" accept=".csv">
                            </label>
                        </div>
                    </div>
                </div>

                <div class="mt-8 text-center">
                    <button id="processBtn" class="w-full md:w-auto bg-indigo-600 text-white font-semibold py-3 px-8 rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-colors duration-200 disabled:bg-gray-400">
                        処理を実行する
                    </button>
                </div>
            </div>

            <!-- Results Section -->
            <div id="resultsContainer" class="space-y-12">
                <div id="finalSummaryResult"></div>
                <div id="grandTotalResult"></div>
                <div id="resultAccount1"></div>
                <div id="resultAccount2"></div>
                <div id="resultRakuten1"></div>
                <div id="resultRakuten2"></div>
                <div id="resultYahoo1"></div>
                <div id="resultYahoo2"></div>
                <div id="resultQoo101"></div>
                <div id="resultQoo102"></div>
                <div id="resultMercari"></div>
            </div>
        </main>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        // Initialize platform tabs
        const platformTabs = document.querySelectorAll('.platform-tab');
        const platformContents = document.querySelectorAll('.platform-content');
        
        platformTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const platform = tab.dataset.platform;
                
                // Update active states
                platformTabs.forEach(t => t.classList.remove('active'));
                platformContents.forEach(c => c.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(`${platform}-content`).classList.add('active');
            });
        });

        // File inputs configuration
        const inputs = {
            amazon: {
                acc1: { 
                    makad: { file: document.getElementById('makadFile1'), name: document.getElementById('fileNameMakad1') }, 
                    hanro: { file: document.getElementById('hanroFile1'), name: document.getElementById('fileNameHanro1') }, 
                    amazon: { file: document.getElementById('amazonFile1'), name: document.getElementById('fileNameAmazon1') }, 
                    ad: { file: document.getElementById('adFile1'), name: document.getElementById('fileNameAd1') }, 
                    container: document.getElementById('resultAccount1') 
                },
                acc2: { 
                    makad: { file: document.getElementById('makadFile2'), name: document.getElementById('fileNameMakad2') }, 
                    hanro: { file: document.getElementById('hanroFile2'), name: document.getElementById('fileNameHanro2') },
                    amazon: { file: document.getElementById('amazonFile2'), name: document.getElementById('fileNameAmazon2') }, 
                    ad: { file: document.getElementById('adFile2'), name: document.getElementById('fileNameAd2') }, 
                    container: document.getElementById('resultAccount2') 
                }
            },
            rakuten: {
                acc1: {
                    sales: { file: document.getElementById('rakutenSales1'), name: document.getElementById('fileNameRakutenSales1') },
                    expense: { file: document.getElementById('rakutenExpense1'), name: document.getElementById('fileNameRakutenExpense1') },
                    container: document.getElementById('resultRakuten1')
                },
                acc2: {
                    sales: { file: document.getElementById('rakutenSales2'), name: document.getElementById('fileNameRakutenSales2') },
                    expense: { file: document.getElementById('rakutenExpense2'), name: document.getElementById('fileNameRakutenExpense2') },
                    container: document.getElementById('resultRakuten2')
                }
            },
            yahoo: {
                acc1: {
                    sales: { file: document.getElementById('yahooSales1'), name: document.getElementById('fileNameYahooSales1') },
                    expense: { file: document.getElementById('yahooExpense1'), name: document.getElementById('fileNameYahooExpense1') },
                    container: document.getElementById('resultYahoo1')
                },
                acc2: {
                    sales: { file: document.getElementById('yahooSales2'), name: document.getElementById('fileNameYahooSales2') },
                    expense: { file: document.getElementById('yahooExpense2'), name: document.getElementById('fileNameYahooExpense2') },
                    container: document.getElementById('resultYahoo2')
                }
            },
            qoo10: {
                acc1: {
                    sales: { file: document.getElementById('qoo10Sales1'), name: document.getElementById('fileNameQoo10Sales1') },
                    expense: { file: document.getElementById('qoo10Expense1'), name: document.getElementById('fileNameQoo10Expense1') },
                    container: document.getElementById('resultQoo101')
                },
                acc2: {
                    sales: { file: document.getElementById('qoo10Sales2'), name: document.getElementById('fileNameQoo10Sales2') },
                    expense: { file: document.getElementById('qoo10Expense2'), name: document.getElementById('fileNameQoo10Expense2') },
                    container: document.getElementById('resultQoo102')
                }
            },
            mercari: {
                sales: { file: document.getElementById('mercariFile'), name: document.getElementById('fileNameMercari') },
                container: document.getElementById('resultMercari')
            }
        };

        const processBtn = document.getElementById('processBtn');
        const toast = document.getElementById('toast');
        const swapBtn = document.getElementById('swapAccountsBtn');

        let processedDataStore = {};

        // Setup file input listeners
        Object.values(inputs).forEach(platform => {
            if (platform.acc1) {
                // For platforms with two accounts
                [platform.acc1, platform.acc2].forEach(acc => {
                    Object.values(acc).forEach(input => {
                        if (input.file) {
                            input.file.addEventListener('change', () => {
                                input.name.textContent = input.file.files.length > 0 ? input.file.files[0].name : 'ファイルを選択';
                            });
                            setupDragDrop(input.file, input.file.parentElement, input.name);
                        }
                    });
                });
            } else {
                // For Mercari (single account)
                if (platform.sales && platform.sales.file) {
                    platform.sales.file.addEventListener('change', () => {
                        platform.sales.name.textContent = platform.sales.file.files.length > 0 ? platform.sales.file.files[0].name : 'ファイルを選択';
                    });
                    setupDragDrop(platform.sales.file, platform.sales.file.parentElement, platform.sales.name);
                }
            }
        });

        // Swap accounts functionality
        swapBtn.addEventListener('click', () => {
            const platforms = ['amazon', 'rakuten', 'yahoo', 'qoo10'];
            
            platforms.forEach(platformName => {
                const platform = inputs[platformName];
                if (platform.acc1 && platform.acc2) {
                    // Swap files for each input type
                    Object.keys(platform.acc1).forEach(key => {
                        if (key !== 'container' && platform.acc1[key].file && platform.acc2[key].file) {
                            // Swap files
                            const tempFiles = platform.acc1[key].file.files;
                            const tempName = platform.acc1[key].name.textContent;
                            
                            platform.acc1[key].file.files = platform.acc2[key].file.files;
                            platform.acc1[key].name.textContent = platform.acc2[key].name.textContent;
                            
                            platform.acc2[key].file.files = tempFiles;
                            platform.acc2[key].name.textContent = tempName;
                        }
                    });
                }
            });
            
            showToast('アカウント1と2のファイルを入れ替えました');
        });
        
        // Drag and drop setup
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => { 
            document.body.addEventListener(eventName, e => { 
                e.preventDefault(); 
                e.stopPropagation(); 
            }); 
        });

        function setupDragDrop(inputElement, labelElement, nameElement) {
            labelElement.addEventListener('drop', e => {
                e.preventDefault(); 
                e.stopPropagation();
                inputElement.files = e.dataTransfer.files;
                nameElement.textContent = inputElement.files[0].name;
                labelElement.classList.remove('border-indigo-500', 'bg-indigo-50');
            });
            labelElement.addEventListener('dragenter', (e) => {
                e.preventDefault(); 
                e.stopPropagation();
                labelElement.classList.add('border-indigo-500', 'bg-indigo-50');
            });
            labelElement.addEventListener('dragleave', (e) => {
                e.preventDefault(); 
                e.stopPropagation();
                labelElement.classList.remove('border-indigo-500', 'bg-indigo-50');
            });
        }

        function showToast(message) {
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => { toast.classList.remove('show'); }, 3000);
        }

        function parseCsv(file, encoding = 'UTF-8') {
            return new Promise((resolve, reject) => {
                if (!file) {
                    resolve({data: [], meta: { fields: [] }});
                    return;
                }
                Papa.parse(file, {
                    encoding: encoding,
                    header: true,
                    skipEmptyLines: true,
                    transformHeader: header => header.trim().replace(/^\uFEFF/, ''),
                    complete: (results) => resolve(results),
                    error: (error) => reject(error)
                });
            });
        }

        const safeNumber = (val) => {
            if (val === null || val === undefined) return 0;
            const cleanString = String(val).replace(/,|¥|円/g, '');
            return Number(cleanString) || 0;
        };
        
        const HEADER_MAP = {
            makadOrderDate: ['注文日'], makadProductName: ['商品名'], makadAsin: ['ASIN'], makadSku: ['SKU'], 
            makadShippingRoute: ['配送経路'], makadSalesPrice: ['販売価格'], makadShippingFee: ['送料'], 
            makadPoints: ['ポイント'], makadDiscount: ['割引'], makadCostPrice: ['仕入れ価格'], 
            makadAmazonFee: ['Amazon手数料'], makadGrossProfit: ['粗利'],
            hanroOrderedAt: ['orderedAt'], hanroSku: ['sku'], hanroItemTitle: ['itemTitle'], 
            hanroQuantity: ['quantity'], hanroAmount: ['amount'], hanroShipmentFee: ['shipmentFee'], 
            hanroCost: ['cost'], hanroProfit: ['profit'], hanroAmazonStatus: ['amazonStatus'],
            mercariPurchaseDate: ['購入日'], mercariCancelDate: ['キャンセル日'], mercariProductName: ['商品名'], 
            mercariQuantity: ['数量'], mercariSalesProfit: ['販売利益'], mercariSales: ['売上（税込）'], 
            mercariFee: ['販売手数料（税込）'],
            amazonTransactionType: ['トランザクションの種類'], amazonTransactionDate: ['日付/時間', '日付／時間'], 
            amazonTotal: ['合計'], amazonDescription: ['説明'],
            adSpend: ['支出', '支出(換算済み)', '支出 (換算済み)'],
        };
        
        const normalize = (str) => (str || '').replace(/[\s\u3000()（）]/g, '').toLowerCase();

        function getColumnMapper(actualHeaders) {
            const mapping = {};
            for (const internalName in HEADER_MAP) {
                const possibleNames = HEADER_MAP[internalName];
                for (const pName of possibleNames) {
                    const normalizedPName = normalize(pName);
                    const foundHeader = actualHeaders.find(h => normalize(h) === normalizedPName);
                    if (foundHeader) {
                        mapping[internalName] = foundHeader;
                        break;
                    }
                }
            }
            return (row, internalName) => {
                const header = mapping[internalName];
                return header ? row[header] : undefined;
            };
        }

        async function processAccountData(makadFile, hanroFile, amazonFile, adFile) {
            const hasAnyFile = makadFile || hanroFile || amazonFile || adFile;
            if (!hasAnyFile) return null;

            const [makadResults, hanroResults, amazonResults, adResults] = await Promise.all([
                parseCsv(makadFile, 'Shift_JIS'),
                parseCsv(hanroFile, 'Shift_JIS'),
                parseCsv(amazonFile, 'UTF-8'),
                parseCsv(adFile, 'UTF-8')
            ]);
            
            const makadData = makadResults.data;
            const hanroData = hanroResults.data;
            const amazonData = amazonResults.data;
            const adData = adResults.data;

            if (makadData.length === 0 && hanroData.length === 0 && amazonData.length === 0 && adData.length === 0) return null;

            let totalSales = 0;
            let totalGrossProfit = 0;
            let allOrderDetails = [];
            const platformSummaries = {};
            const expenseSummary = {};
            
            if (makadData.length > 0 || hanroData.length > 0) {
                const getMakadValue = getColumnMapper(makadResults.meta.fields);
                const getHanroValue = getColumnMapper(hanroResults.meta.fields);

                const costLookup = {};
                makadData.forEach(row => {
                    const sku = getMakadValue(row, 'makadSku');
                    const cost = safeNumber(getMakadValue(row, 'makadCostPrice'));
                    if (sku && cost > 0 && !costLookup[sku]) {
                        costLookup[sku] = cost;
                    }
                });

                const makadOrderDetails = makadData.map(row => ({
                    '注文日時': getMakadValue(row, 'makadOrderDate') || '', 
                    '販売経路': 'マカド', 
                    'SKU': getMakadValue(row, 'makadSku') || '', 
                    '商品名': getMakadValue(row, 'makadProductName') || '', 
                    '販売金額': safeNumber(getMakadValue(row, 'makadSalesPrice')), 
                    '手数料': safeNumber(getMakadValue(row, 'makadAmazonFee')), 
                    '仕入れ価格': safeNumber(getMakadValue(row, 'makadCostPrice')), 
                    '粗利': safeNumber(getMakadValue(row, 'makadGrossProfit')), 
                    'ステータス': '',
                }));

                const hanroOrderDetails = hanroData
                    .filter(row => getHanroValue(row, 'hanroAmazonStatus') !== 'FAILED')
                    .map(row => {
                        const sku = getHanroValue(row, 'hanroSku');
                        let cost = safeNumber(getHanroValue(row, 'hanroCost'));
                        if (cost === 0 && sku && costLookup[sku]) {
                            cost = costLookup[sku];
                        }
                        const amount = safeNumber(getHanroValue(row, 'hanroAmount'));
                        const fee = safeNumber(getHanroValue(row, 'hanroShipmentFee'));
                        const profit = amount - fee - cost;
                        return {
                            '注文日時': getHanroValue(row, 'hanroOrderedAt') || '', 
                            '販売経路': 'hanro+', 
                            'SKU': sku || '', 
                            '商品名': getHanroValue(row, 'hanroItemTitle') || '', 
                            '販売金額': amount, 
                            '手数料': fee, 
                            '仕入れ価格': cost, 
                            '粗利': profit, 
                            'ステータス': getHanroValue(row, 'hanroAmazonStatus') || '',
                        };
                    });
                
                allOrderDetails = [...makadOrderDetails, ...hanroOrderDetails];

                allOrderDetails.forEach(order => {
                    const platform = order['販売経路'];
                    if (!platformSummaries[platform]) {
                        platformSummaries[platform] = { sales: 0, profit: 0, fees: 0, cost: 0 };
                    }
                    platformSummaries[platform].sales += order['販売金額'];
                    platformSummaries[platform].profit += order['粗利'];
                    platformSummaries[platform].fees += order['手数料'];
                    platformSummaries[platform].cost += order['仕入れ価格'];
                });

                totalSales = allOrderDetails.reduce((sum, row) => sum + row['販売金額'], 0);
                totalGrossProfit = allOrderDetails.reduce((sum, row) => sum + row['粗利'], 0);
            }

            if (amazonData.length > 0) {
                const getAmazonValue = getColumnMapper(amazonResults.meta.fields);
                const expenseKeywords = [ 
                    'FBA在庫保管手数料', 'FBA長期在庫保管手数料', 'FBA在庫の返送手数料', 
                    'FBA在庫の返金', 'FBAパートナーキャリア', 'FBAパートナーキャリアの配送料', 
                    'Amazon 経由で購入した配送ラベル' 
                ];
                amazonData.forEach(row => {
                    const transactionType = (getAmazonValue(row, 'amazonTransactionType') || '').trim();
                    const description = (getAmazonValue(row, 'amazonDescription') || '').trim();
                    const amount = safeNumber(getAmazonValue(row, 'amazonTotal'));
                    
                    const matchedKeyword = expenseKeywords.find(keyword => 
                        transactionType.includes(keyword) || description.includes(keyword)
                    );
                    
                    if (matchedKeyword) {
                        if (!expenseSummary[matchedKeyword]) { expenseSummary[matchedKeyword] = 0; }
                        expenseSummary[matchedKeyword] += amount;
                    }
                });
            }

            if (adData.length > 0) {
                const getAdValue = getColumnMapper(adResults.meta.fields);
                const adSpendTotal = adData.reduce((sum, row) => sum + safeNumber(getAdValue(row, 'adSpend')), 0);
                if (adSpendTotal !== 0) {
                    expenseSummary['Amazon広告費'] = -adSpendTotal;
                }
            }
            
            const totalExpenses = Object.values(expenseSummary).reduce((sum, val) => sum + val, 0);
            const finalProfit = totalGrossProfit + totalExpenses;
            
            return {
                accountSummary: { totalSales, totalGrossProfit, totalExpenses, finalProfit },
                platformSummaries,
                orderDetails: allOrderDetails,
                expenseSummary
            };
        }

        async function processPlatformData(salesFile, expenseFile, platform) {
            if (!salesFile && !expenseFile) return null;

            const [salesResults, expenseResults] = await Promise.all([
                parseCsv(salesFile, 'UTF-8'),
                parseCsv(expenseFile, 'UTF-8')
            ]);

            const salesData = salesResults.data;
            const expenseData = expenseResults.data;

            let totalSales = 0;
            let totalExpenses = 0;

            // Process sales data based on platform
            salesData.forEach(row => {
                // Generic sales processing - look for common sales columns
                const possibleSalesColumns = ['売上', '売上高', '売上金額', '販売金額', '受注金額', '決済金額'];
                for (const col of possibleSalesColumns) {
                    if (row[col] !== undefined) {
                        totalSales += safeNumber(row[col]);
                        break;
                    }
                }
            });

            // Process expense data
            expenseData.forEach(row => {
                const possibleExpenseColumns = ['経費', '手数料', '費用', 'コスト', '支払い'];
                for (const col of possibleExpenseColumns) {
                    if (row[col] !== undefined) {
                        totalExpenses += safeNumber(row[col]);
                        break;
                    }
                }
            });

            const finalProfit = totalSales - totalExpenses;

            return {
                accountSummary: { 
                    totalSales, 
                    totalGrossProfit: finalProfit, 
                    totalExpenses: -totalExpenses, 
                    finalProfit 
                },
                platformSummaries: {
                    [platform]: { 
                        sales: totalSales, 
                        profit: finalProfit, 
                        fees: totalExpenses, 
                        cost: 0 
                    }
                },
                orderDetails: [],
                expenseSummary: { [`${platform}経費`]: -totalExpenses }
            };
        }
        
        async function processMercariData(mercariFile) {
            if (!mercariFile) return null;

            const mercariResults = await parseCsv(mercariFile, 'Shift_JIS');
            const mercariData = mercariResults.data;
            if (mercariData.length === 0) return null;
            
            const getMercariValue = getColumnMapper(mercariResults.meta.fields);
            
            let totalShipping = 0;
            const orderDetails = mercariData
                .filter(row => !getMercariValue(row, 'mercariCancelDate'))
                .map(row => {
                    const quantity = safeNumber(getMercariValue(row, 'mercariQuantity'));
                    const shippingFee = 550 * quantity;
                    totalShipping += shippingFee;
                    const sales = safeNumber(getMercariValue(row, 'mercariSales'));
                    const fee = safeNumber(getMercariValue(row, 'mercariFee'));
                    const profit = sales - fee - shippingFee;
                    return {
                        '注文日時': getMercariValue(row, 'mercariPurchaseDate') || '', 
                        '販売経路': 'メルカリShops', 
                        'SKU': '', 
                        '商品名': getMercariValue(row, 'mercariProductName') || '', 
                        '販売金額': sales, 
                        '手数料': fee + shippingFee, 
                        '仕入れ価格': 0, 
                        '粗利': profit, 
                        'ステータス': '購入',
                    };
                });

            const totalSales = orderDetails.reduce((sum, row) => sum + row['販売金額'], 0);
            const totalGrossProfit = orderDetails.reduce((sum, row) => sum + row['粗利'], 0);
            const totalFees = orderDetails.reduce((sum, row) => sum + row['手数料'], 0);
            
            const expenseSummary = {};
            if (totalShipping > 0) {
                expenseSummary['配送料'] = -totalShipping;
            }

            return {
                accountSummary: { totalSales, totalGrossProfit, totalExpenses: -totalShipping, finalProfit: totalGrossProfit },
                platformSummaries: { 'メルカリShops': { sales: totalSales, profit: totalGrossProfit, fees: totalFees, cost: 0 } },
                orderDetails: orderDetails,
                expenseSummary
            };
        }

        function renderAccountResults(container, data, accountName) {
            if (!container) return;
            container.innerHTML = '';
            if (!data || !data.accountSummary) { 
                container.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-md text-center text-gray-500">${accountName}のデータは処理されませんでした。</div>`;
                return; 
            }
            const { accountSummary, platformSummaries, orderDetails, expenseSummary } = data;
            const finalProfitColor = accountSummary.finalProfit >= 0 ? 'text-green-600' : 'text-red-600';

            container.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold mb-6 text-center">${accountName} 集計結果</h2>
                    <details class="border rounded-lg p-4 mb-8" open>
                        <summary class="font-semibold text-xl flex justify-between items-center">
                            <span>アカウントサマリー</span>
                            <span class="text-sm text-gray-500">クリックして開閉</span>
                        </summary>
                        <div class="mt-4">
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 text-center">
                                <div class="summary-card p-4 rounded-lg">
                                    <p class="text-sm font-medium text-gray-500">合計売上</p>
                                    <p class="mt-1 text-2xl font-semibold text-gray-900">${accountSummary.totalSales.toLocaleString()}円</p>
                                </div>
                                <div class="summary-card p-4 rounded-lg">
                                    <p class="text-sm font-medium text-gray-500">粗利合計</p>
                                    <p class="mt-1 text-2xl font-semibold text-blue-600">${accountSummary.totalGrossProfit.toLocaleString()}円</p>
                                </div>
                                <div class="summary-card p-4 rounded-lg">
                                    <p class="text-sm font-medium text-gray-500">総経費</p>
                                    <p class="mt-1 text-2xl font-semibold text-red-600">${Math.abs(accountSummary.totalExpenses).toLocaleString()}円</p>
                                </div>
                                <div class="summary-card p-4 rounded-lg">
                                    <p class="text-sm font-medium text-gray-500">最終利益</p>
                                    <p class="mt-1 text-2xl font-semibold ${finalProfitColor}">${accountSummary.finalProfit.toLocaleString()}円</p>
                                </div>
                            </div>
                        </div>
                    </details>
                    ${orderDetails && orderDetails.length > 0 ? `
                    <details class="border rounded-lg p-4">
                        <summary class="font-semibold text-xl flex justify-between items-center">
                            <span>売上詳細</span>
                            <span class="text-sm text-gray-500">クリックして開閉</span>
                        </summary>
                        <div class="mt-4 overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200" id="table-orders-${accountName}"></table>
                        </div>
                    </details>` : ''}
                </div>`;
            
            if (orderDetails && orderDetails.length > 0) {
                renderTable(`table-orders-${accountName}`, orderDetails);
            }
        }
        
        function renderTable(tableId, data) {
            const table = document.getElementById(tableId);
            if (!table) return;
            if (data.length === 0) {
                table.innerHTML = '<tbody><tr><td class="p-4 text-center text-gray-500">該当するデータがありません。</td></tr></tbody>';
                return;
            };
            const headers = Object.keys(data[0]);
            const thead = `<thead><tr class="bg-gray-50">${headers.map(h => `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${h}</th>`).join('')}</tr></thead>`;
            const tbody = `<tbody>${data.map(row => `<tr>${headers.map(h => `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${typeof row[h] === 'number' ? row[h].toLocaleString() : (row[h] || '')}</td>`).join('')}</tr>`).join('')}</tbody>`;
            table.innerHTML = thead + tbody;
        }
        
        function renderGrandTotal(allData) {
            const container = document.getElementById('grandTotalResult');
            container.innerHTML = '';
            
            const validData = allData.filter(d => d && d.accountSummary);
            if (validData.length === 0) return;

            const grandTotalSales = validData.reduce((sum, d) => sum + d.accountSummary.totalSales, 0);
            const grandTotalGrossProfit = validData.reduce((sum, d) => sum + d.accountSummary.totalGrossProfit, 0);
            const grandTotalExpenses = validData.reduce((sum, d) => sum + d.accountSummary.totalExpenses, 0);
            const grandTotalFinalProfit = validData.reduce((sum, d) => sum + d.accountSummary.finalProfit, 0);

            const finalProfitColor = grandTotalFinalProfit >= 0 ? 'text-green-600' : 'text-red-600';

            container.innerHTML = `
                <div class="bg-indigo-800 text-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-4 text-center">総合計サマリー</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 text-center">
                        <div class="bg-indigo-700 p-4 rounded-lg">
                            <p class="text-sm font-medium text-indigo-200">合計売上</p>
                            <p class="mt-1 text-2xl font-semibold">${grandTotalSales.toLocaleString()}円</p>
                        </div>
                        <div class="bg-indigo-700 p-4 rounded-lg">
                            <p class="text-sm font-medium text-indigo-200">粗利合計</p>
                            <p class="mt-1 text-2xl font-semibold">${grandTotalGrossProfit.toLocaleString()}円</p>
                        </div>
                        <div class="bg-indigo-700 p-4 rounded-lg">
                            <p class="text-sm font-medium text-indigo-200">総経費</p>
                            <p class="mt-1 text-2xl font-semibold">${Math.abs(grandTotalExpenses).toLocaleString()}円</p>
                        </div>
                        <div class="bg-indigo-700 p-4 rounded-lg">
                            <p class="text-sm font-medium text-indigo-200">最終利益</p>
                            <p class="mt-1 text-2xl font-semibold ${finalProfitColor}">${grandTotalFinalProfit.toLocaleString()}円</p>
                        </div>
                    </div>
                </div>`;
        }

        processBtn.addEventListener('click', async () => {
            processBtn.disabled = true;
            processBtn.textContent = '処理中...';

            try {
                // Process Amazon accounts
                processedDataStore.amazonAcc1 = await processAccountData(
                    inputs.amazon.acc1.makad.file.files[0], 
                    inputs.amazon.acc1.hanro.file.files[0], 
                    inputs.amazon.acc1.amazon.file.files[0], 
                    inputs.amazon.acc1.ad.file.files[0]
                );
                processedDataStore.amazonAcc2 = await processAccountData(
                    inputs.amazon.acc2.makad.file.files[0], 
                    inputs.amazon.acc2.hanro.file.files[0], 
                    inputs.amazon.acc2.amazon.file.files[0], 
                    inputs.amazon.acc2.ad.file.files[0]
                );

                // Process Rakuten accounts
                processedDataStore.rakutenAcc1 = await processPlatformData(
                    inputs.rakuten.acc1.sales.file.files[0],
                    inputs.rakuten.acc1.expense.file.files[0],
                    '楽天'
                );
                processedDataStore.rakutenAcc2 = await processPlatformData(
                    inputs.rakuten.acc2.sales.file.files[0],
                    inputs.rakuten.acc2.expense.file.files[0],
                    '楽天'
                );

                // Process Yahoo accounts
                processedDataStore.yahooAcc1 = await processPlatformData(
                    inputs.yahoo.acc1.sales.file.files[0],
                    inputs.yahoo.acc1.expense.file.files[0],
                    'Yahoo!'
                );
                processedDataStore.yahooAcc2 = await processPlatformData(
                    inputs.yahoo.acc2.sales.file.files[0],
                    inputs.yahoo.acc2.expense.file.files[0],
                    'Yahoo!'
                );

                // Process Qoo10 accounts
                processedDataStore.qoo10Acc1 = await processPlatformData(
                    inputs.qoo10.acc1.sales.file.files[0],
                    inputs.qoo10.acc1.expense.file.files[0],
                    'Qoo10'
                );
                processedDataStore.qoo10Acc2 = await processPlatformData(
                    inputs.qoo10.acc2.sales.file.files[0],
                    inputs.qoo10.acc2.expense.file.files[0],
                    'Qoo10'
                );

                // Process Mercari
                processedDataStore.mercari = await processMercariData(inputs.mercari.sales.file.files[0]);
                
                // Render results
                renderAccountResults(inputs.amazon.acc1.container, processedDataStore.amazonAcc1, 'Amazon アカウント1');
                renderAccountResults(inputs.amazon.acc2.container, processedDataStore.amazonAcc2, 'Amazon アカウント2');
                renderAccountResults(inputs.rakuten.acc1.container, processedDataStore.rakutenAcc1, '楽天 アカウント1');
                renderAccountResults(inputs.rakuten.acc2.container, processedDataStore.rakutenAcc2, '楽天 アカウント2');
                renderAccountResults(inputs.yahoo.acc1.container, processedDataStore.yahooAcc1, 'Yahoo! アカウント1');
                renderAccountResults(inputs.yahoo.acc2.container, processedDataStore.yahooAcc2, 'Yahoo! アカウント2');
                renderAccountResults(inputs.qoo10.acc1.container, processedDataStore.qoo10Acc1, 'Qoo10 アカウント1');
                renderAccountResults(inputs.qoo10.acc2.container, processedDataStore.qoo10Acc2, 'Qoo10 アカウント2');
                renderAccountResults(inputs.mercari.container, processedDataStore.mercari, 'メルカリShops');

                const allData = [
                    processedDataStore.amazonAcc1, 
                    processedDataStore.amazonAcc2,
                    processedDataStore.rakutenAcc1,
                    processedDataStore.rakutenAcc2,
                    processedDataStore.yahooAcc1,
                    processedDataStore.yahooAcc2,
                    processedDataStore.qoo10Acc1,
                    processedDataStore.qoo10Acc2,
                    processedDataStore.mercari
                ];
                renderGrandTotal(allData);
                
                showToast('処理が完了しました。');
            } catch (error) {
                console.error('CSV処理エラー:', error);
                showToast('エラーが発生しました。コンソールを確認してください。');
            } finally {
                processBtn.disabled = false;
                processBtn.textContent = '処理を実行する';
            }
        });
    </script>
</body>
</html>