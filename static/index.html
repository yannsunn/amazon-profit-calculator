<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon売上利益計算システム（完全版）</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: #2c3e50;
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .header p {
            font-size: 1rem;
            opacity: 0.9;
        }
        
        .main-content {
            padding: 40px;
        }
        
        .upload-section {
            margin-bottom: 40px;
        }
        
        .upload-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .account-section {
            margin-bottom: 40px;
        }
        
        .account-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
        }
        
        .mercari-section {
            margin: 40px 0;
            text-align: center;
        }
        
        .mercari-section .upload-item {
            max-width: 400px;
            margin: 0 auto;
        }
        
        .section-title {
            font-weight: 600;
            color: #2c3e50;
            margin: 15px 0 10px 0;
            padding-bottom: 5px;
            border-bottom: 1px solid #ecf0f1;
            font-size: 0.9rem;
        }
        
        .month-selection {
            margin-bottom: 40px;
            text-align: center;
        }
        
        .month-selector {
            margin: 20px 0;
        }
        
        .month-select {
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
            color: #333;
            min-width: 250px;
            cursor: pointer;
        }
        
        .month-select:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .saved-months {
            margin: 40px 0;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .saved-months h3 {
            margin-bottom: 20px;
            color: #2c3e50;
        }
        
        .month-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .month-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .month-card:hover {
            border-color: #3498db;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .month-card.has-data {
            border-color: #27ae60;
            background: #f0f8f3;
        }
        
        .month-card-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .month-card-status {
            font-size: 0.9rem;
            color: #7f8c8d;
        }
        
        .month-card.has-data .month-card-status {
            color: #27ae60;
        }
        
        .upload-item {
            border: 2px dashed #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            transition: all 0.2s ease;
            background: #fafafa;
            position: relative;
            cursor: pointer;
        }
        
        .upload-item:hover {
            border-color: #2c3e50;
            background: #f8f8f8;
        }
        
        .upload-item.has-file {
            border-color: #27ae60;
            background: #f0f8f3;
        }
        
        .upload-item.drag-over {
            border-color: #3498db;
            background: #e3f2fd;
            transform: scale(1.02);
        }
        
        .upload-item.drag-over::before {
            content: 'ファイルをドロップしてください';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.1rem;
            font-weight: 600;
            color: #3498db;
            z-index: 10;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 20px;
            border-radius: 4px;
        }
        
        .upload-instruction {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-top: 10px;
        }
        
        .upload-item h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        
        .file-input {
            display: none;
        }
        
        .file-label {
            display: inline-block;
            padding: 10px 20px;
            background: #3498db;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s ease;
            font-weight: 500;
        }
        
        .file-label:hover {
            background: #2980b9;
        }
        
        .file-name {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #27ae60;
            font-weight: 500;
        }
        
        .button-section {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin: 40px 0;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 160px;
        }
        
        .btn-validate {
            background: #95a5a6;
            color: white;
        }
        
        .btn-validate:hover {
            background: #7f8c8d;
        }
        
        .btn-calculate {
            background: #27ae60;
            color: white;
        }
        
        .btn-calculate:hover {
            background: #229954;
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .results-section {
            margin-top: 40px;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 8px;
            display: none;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background: white;
            padding: 25px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border-left: 4px solid #3498db;
        }
        
        .summary-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        
        .summary-card h3 {
            color: #7f8c8d;
            font-size: 0.85rem;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }
        
        .summary-card .value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .summary-card.sales {
            border-left-color: #3498db;
        }
        
        .summary-card.profit {
            border-left-color: #27ae60;
        }
        
        .summary-card.rate {
            border-left-color: #f39c12;
        }
        
        .summary-card.months {
            border-left-color: #9b59b6;
        }
        
        .change-indicator {
            font-size: 0.8rem;
            margin-top: 5px;
            font-weight: 500;
        }
        
        .change-positive {
            color: #27ae60;
        }
        
        .change-negative {
            color: #e74c3c;
        }
        
        .change-neutral {
            color: #7f8c8d;
        }
        
        .trend-section {
            margin: 30px 0;
            padding: 25px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .trend-section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.1rem;
        }
        
        .trend-chart {
            display: flex;
            align-items: end;
            height: 150px;
            gap: 8px;
            padding: 10px 0;
            border-bottom: 2px solid #ecf0f1;
            position: relative;
        }
        
        .trend-bar {
            flex: 1;
            background: linear-gradient(to top, #3498db, #5dade2);
            border-radius: 4px 4px 0 0;
            min-height: 10px;
            position: relative;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .trend-bar:hover {
            background: linear-gradient(to top, #2980b9, #3498db);
            transform: scaleY(1.05);
        }
        
        .trend-bar-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8rem;
            color: #7f8c8d;
            white-space: nowrap;
        }
        
        .trend-bar-value {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.75rem;
            color: #2c3e50;
            background: rgba(255,255,255,0.9);
            padding: 2px 6px;
            border-radius: 3px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .trend-bar:hover .trend-bar-value {
            opacity: 1;
        }

        /* 保存済みデータ管理 */
        .saved-data-section {
            margin: 30px 0;
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .saved-data-section h2 {
            margin-bottom: 20px;
            color: #333;
            font-size: 1.3em;
        }

        .saved-data-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .saved-data-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }

        .saved-data-item {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .saved-data-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .saved-data-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }

        .saved-data-summary {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 12px;
        }

        .saved-data-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.8em;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-view {
            background: #007bff;
            color: white;
        }

        .btn-view:hover {
            background: #0056b3;
        }

        .btn-export {
            background: #28a745;
            color: white;
        }

        .btn-export:hover {
            background: #1e7e34;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
        }

        .btn-delete:hover {
            background: #c82333;
        }
        
        
        .monthly-results {
            background: white;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .monthly-results h3 {
            background: #34495e;
            color: white;
            padding: 15px 20px;
            margin: 0;
            font-size: 1.1rem;
        }
        
        .month-item {
            border-bottom: 1px solid #eee;
            padding: 20px;
        }
        
        .month-item:last-child {
            border-bottom: none;
        }
        
        .month-header {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
        }
        
        .month-data {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .data-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .data-label {
            font-weight: 500;
            color: #555;
        }
        
        .data-value {
            font-weight: 600;
            color: #333;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            display: none;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #c3e6cb;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .upload-grid {
                grid-template-columns: 1fr;
            }
            
            .button-section {
                flex-direction: column;
                align-items: center;
            }
            
            .summary-cards {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .month-data {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Amazon売上利益計算システム</h1>
            <p>複数のAmazonアカウントと販路のCSVデータを統合し、月次利益を自動計算</p>
        </div>
        
        <div class="main-content">
            <div class="month-selection">
                <h2 style="text-align: center; margin-bottom: 20px; color: #333;">対象月選択</h2>
                <div class="month-selector">
                    <select id="target-month" class="month-select">
                        <option value="">月を選択してください</option>
                    </select>
                </div>
            </div>
            
            <div class="upload-section">
                <h2 style="text-align: center; margin-bottom: 40px; color: #333;">CSVファイルをアップロード</h2>
                
                <!-- A-Mアカウント -->
                <div class="account-section">
                    <div class="account-title">A-M アカウント</div>
                    <div class="upload-grid">
                        <div class="upload-item" id="upload-makad-a-m" data-file-type="makad-a-m">
                            <h3>マカド売上データ</h3>
                            <input type="file" class="file-input" id="file-makad-a-m" accept=".csv">
                            <label for="file-makad-a-m" class="file-label">ファイルを選択</label>
                            <div class="upload-instruction">またはファイルをドラッグ&ドロップ</div>
                            <div class="file-name" id="name-makad-a-m"></div>
                        </div>
                        
                        <div class="upload-item" id="upload-hanro-a-m" data-file-type="hanro-a-m">
                            <h3>販路プラス売上データ</h3>
                            <input type="file" class="file-input" id="file-hanro-a-m" accept=".csv">
                            <label for="file-hanro-a-m" class="file-label">ファイルを選択</label>
                            <div class="upload-instruction">またはファイルをドラッグ&ドロップ</div>
                            <div class="file-name" id="name-hanro-a-m"></div>
                        </div>
                    </div>
                </div>
                
                <!-- メルカリショップ -->
                <div class="mercari-section">
                    <div class="account-title">メルカリショップ</div>
                    <div class="upload-item" id="upload-mercari" data-file-type="mercari">
                        <h3>メルカリショップ売上データ</h3>
                        <input type="file" class="file-input" id="file-mercari" accept=".csv">
                        <label for="file-mercari" class="file-label">ファイルを選択</label>
                        <div class="upload-instruction">またはファイルをドラッグ&ドロップ</div>
                        <div class="file-name" id="name-mercari"></div>
                    </div>
                </div>
                
                <!-- O-AAアカウント -->
                <div class="account-section">
                    <div class="account-title">O-AA アカウント</div>
                    <div class="upload-grid">
                        <div class="upload-item" id="upload-makad-o-aa" data-file-type="makad-o-aa">
                            <h3>マカド売上データ</h3>
                            <input type="file" class="file-input" id="file-makad-o-aa" accept=".csv">
                            <label for="file-makad-o-aa" class="file-label">ファイルを選択</label>
                            <div class="upload-instruction">またはファイルをドラッグ&ドロップ</div>
                            <div class="file-name" id="name-makad-o-aa"></div>
                        </div>
                        
                        <div class="upload-item" id="upload-hanro-o-aa" data-file-type="hanro-o-aa">
                            <h3>販路プラス売上データ</h3>
                            <input type="file" class="file-input" id="file-hanro-o-aa" accept=".csv">
                            <label for="file-hanro-o-aa" class="file-label">ファイルを選択</label>
                            <div class="upload-instruction">またはファイルをドラッグ&ドロップ</div>
                            <div class="file-name" id="name-hanro-o-aa"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="button-section">
                <button class="btn btn-validate" onclick="validateFiles()">ファイル検証</button>
                <button class="btn btn-calculate" onclick="calculateProfit()">利益計算を実行</button>
            </div>
            
            <div class="saved-months" id="saved-months" style="display: none;">
                <h3>保存済み月データ</h3>
                <div class="month-grid" id="month-grid">
                    <!-- 月カードがここに表示されます -->
                </div>
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>処理中です。しばらくお待ちください...</p>
            </div>
            
            <div id="message-area"></div>
            
            <!-- 保存済みデータ管理セクション -->
            <div class="saved-data-section" id="saved-data-section" style="display: none;">
                <h2>保存済みデータ管理</h2>
                <div class="saved-data-controls">
                    <button type="button" onclick="loadSavedDataList()" class="btn-secondary">
                        リスト更新
                    </button>
                    <button type="button" onclick="exportAllData()" class="btn-secondary">
                        全データエクスポート
                    </button>
                </div>
                <div class="saved-data-list" id="saved-data-list">
                    <!-- 保存済みデータのリストがここに表示されます -->
                </div>
            </div>

            <div class="results-section" id="results">
                <h2 style="margin-bottom: 30px; color: #333;">計算結果</h2>
                
                <div class="summary-cards" id="summary-cards">
                    <!-- サマリー情報がここに表示されます -->
                </div>
                
                <div class="trend-section" id="trend-section" style="display: none;">
                    <h3>売上トレンド</h3>
                    <div class="trend-chart" id="trend-chart">
                        <!-- トレンドグラフがここに表示されます -->
                    </div>
                </div>
                
                <div class="monthly-results">
                    <h3>月別詳細結果</h3>
                    <div id="monthly-data">
                        <!-- 月別データがここに表示されます -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let monthsData = [];
        
        // ページ読み込み時に月リストを取得
        document.addEventListener('DOMContentLoaded', function() {
            loadMonthsList();
            loadSavedDataList();
        });
        
        // 月リストを読み込み
        async function loadMonthsList() {
            try {
                const response = await fetch('/api/months');
                const result = await response.json();
                
                if (result.success) {
                    monthsData = result.months;
                    populateMonthSelect();
                    displaySavedMonths();
                } else {
                    showMessage('月リストの読み込みに失敗しました', 'error');
                }
            } catch (error) {
                showMessage(`月リスト読み込みエラー: ${error.message}`, 'error');
            }
        }
        
        // 月選択セレクトボックスを設定
        function populateMonthSelect() {
            const select = document.getElementById('target-month');
            select.innerHTML = '<option value="">月を選択してください</option>';
            
            monthsData.forEach(month => {
                const option = document.createElement('option');
                option.value = month.key;
                option.textContent = month.display + (month.has_data ? ' (保存済み)' : '');
                select.appendChild(option);
            });
        }
        
        // 保存済み月データを表示
        function displaySavedMonths() {
            const savedMonths = monthsData.filter(month => month.has_data);
            const savedMonthsSection = document.getElementById('saved-months');
            const monthGrid = document.getElementById('month-grid');
            
            if (savedMonths.length > 0) {
                savedMonthsSection.style.display = 'block';
                monthGrid.innerHTML = '';
                
                savedMonths.forEach(month => {
                    const card = document.createElement('div');
                    card.className = 'month-card has-data';
                    card.onclick = () => viewMonthData(month.key);
                    
                    card.innerHTML = `
                        <div class="month-card-title">${month.display}</div>
                        <div class="month-card-status">データあり</div>
                    `;
                    
                    monthGrid.appendChild(card);
                });
            } else {
                savedMonthsSection.style.display = 'none';
            }
        }
        
        // 月データを表示
        async function viewMonthData(monthKey) {
            try {
                const response = await fetch(`/api/months/${monthKey}`);
                const result = await response.json();
                
                if (result.success) {
                    // スプレッドシートデータを表示
                    const mockResult = {
                        spreadsheet_data: result.data.spreadsheet_data,
                        summary: {
                            total_months: 1,
                            total_sales: result.data.spreadsheet_data.reduce((sum, row) => sum + row['売上高合計'], 0),
                            total_profit: result.data.spreadsheet_data.reduce((sum, row) => sum + row['売上総利益'], 0),
                            average_profit_rate: 0
                        }
                    };
                    
                    mockResult.summary.average_profit_rate = mockResult.summary.total_sales > 0 
                        ? (mockResult.summary.total_profit / mockResult.summary.total_sales * 100) 
                        : 0;
                    
                    displayResults(mockResult);
                    showMessage(`${result.display_name}のデータを表示しました`, 'success');
                } else {
                    showMessage(result.error, 'error');
                }
            } catch (error) {
                showMessage(`データ読み込みエラー: ${error.message}`, 'error');
            }
        }
        
        // 保存済み月データを再読み込み
        function loadSavedMonths() {
            // この関数はloadMonthsList()で一緒に処理されるため、空のままにしておく
        }
        
        // ファイル選択処理
        function handleFileSelect(file, uploadItem) {
            const fileInput = uploadItem.querySelector('.file-input');
            const fileName = uploadItem.querySelector('.file-name');
            
            // ファイル形式チェック
            if (file && file.name.toLowerCase().endsWith('.csv')) {
                // FileListオブジェクトを作成してinputに設定
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                fileInput.files = dataTransfer.files;
                
                fileName.textContent = file.name;
                uploadItem.classList.add('has-file');
                uploadItem.classList.remove('drag-over');
            } else {
                showMessage('CSVファイルのみアップロード可能です。', 'error');
                uploadItem.classList.remove('drag-over');
            }
        }
        
        // 通常のファイル選択処理
        document.querySelectorAll('.file-input').forEach(input => {
            input.addEventListener('change', function() {
                const uploadItem = this.closest('.upload-item');
                const fileName = uploadItem.querySelector('.file-name');
                
                if (this.files.length > 0) {
                    fileName.textContent = this.files[0].name;
                    uploadItem.classList.add('has-file');
                } else {
                    fileName.textContent = '';
                    uploadItem.classList.remove('has-file');
                }
            });
        });
        
        // ドラッグ&ドロップ処理
        document.querySelectorAll('.upload-item').forEach(uploadItem => {
            // ドラッグオーバー時の処理
            uploadItem.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.classList.add('drag-over');
            });
            
            // ドラッグリーブ時の処理
            uploadItem.addEventListener('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                // 子要素から出た場合は無視
                if (!this.contains(e.relatedTarget)) {
                    this.classList.remove('drag-over');
                }
            });
            
            // ドロップ時の処理
            uploadItem.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect(files[0], this);
                }
            });
            
            // クリック時の処理（既存のラベルクリックと同じ動作）
            uploadItem.addEventListener('click', function(e) {
                // ラベルやinputがクリックされた場合は無視
                if (e.target.tagName === 'LABEL' || e.target.tagName === 'INPUT') {
                    return;
                }
                
                const fileInput = this.querySelector('.file-input');
                fileInput.click();
            });
        });
        
        // ページ全体でのドラッグ&ドロップを無効化（ブラウザのデフォルト動作を防ぐ）
        document.addEventListener('dragover', function(e) {
            e.preventDefault();
        });
        
        document.addEventListener('drop', function(e) {
            e.preventDefault();
        });

        // メッセージ表示
        function showMessage(message, type = 'info') {
            const messageArea = document.getElementById('message-area');
            const className = type === 'error' ? 'error' : 'success';
            messageArea.innerHTML = `<div class="${className}">${message}</div>`;
            setTimeout(() => {
                messageArea.innerHTML = '';
            }, 5000);
        }

        // ローディング表示
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // ファイル検証
        async function validateFiles() {
            const formData = new FormData();
            let hasFiles = false;

            // ファイルを FormData に追加
            const fileInputs = [
                'file-makad-a-m', 'file-mercari', 'file-hanro-a-m',
                'file-makad-o-aa', 'file-hanro-o-aa'
            ];

            fileInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input.files.length > 0) {
                    const key = inputId.replace('file-', '').replace('-', '_');
                    formData.append(key, input.files[0]);
                    hasFiles = true;
                }
            });

            if (!hasFiles) {
                showMessage('ファイルを選択してください。', 'error');
                return;
            }

            showLoading(true);

            try {
                const response = await fetch('/api/profit/validate', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    let message = 'ファイル検証が完了しました。\\n\\n';
                    Object.entries(result.validation_results).forEach(([key, validation]) => {
                        message += `${key}: ${validation.valid ? '✅ 正常' : '❌ エラー'}\\n`;
                        if (!validation.valid) {
                            message += `エラー内容: ${validation.error}\\n`;
                        }
                    });
                    showMessage(message, 'success');
                } else {
                    showMessage(`検証エラー: ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage(`通信エラー: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // 利益計算実行
        async function calculateProfit() {
            const targetMonth = document.getElementById('target-month').value;
            if (!targetMonth) {
                showMessage('対象月を選択してください。', 'error');
                return;
            }
            
            const formData = new FormData();
            let hasFiles = false;

            // 対象月を追加
            formData.append('target_month', targetMonth);

            // ファイルを FormData に追加
            const fileInputs = [
                'file-makad-a-m', 'file-mercari', 'file-hanro-a-m',
                'file-makad-o-aa', 'file-hanro-o-aa'
            ];

            fileInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input.files.length > 0) {
                    const key = inputId.replace('file-', '').replace('-', '_');
                    formData.append(key, input.files[0]);
                    hasFiles = true;
                }
            });

            if (!hasFiles) {
                showMessage('ファイルを選択してください。', 'error');
                return;
            }

            showLoading(true);

            try {
                const response = await fetch('/api/profit/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    showMessage(result.message, 'success');
                    displayResults(result);
                    // 月リストを再読み込みしてステータスを更新
                    await loadMonthsList();
                } else {
                    showMessage(`計算エラー: ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage(`通信エラー: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // 結果表示
        function displayResults(result) {
            // 改善されたサマリー表示
            const summaryCards = document.getElementById('summary-cards');
            summaryCards.innerHTML = `
                <div class="summary-card months">
                    <h3>処理月数</h3>
                    <div class="value">${result.summary.total_months}</div>
                    <div class="change-indicator change-neutral">ヶ月のデータ</div>
                </div>
                <div class="summary-card sales">
                    <h3>総売上</h3>
                    <div class="value">¥${formatLargeNumber(result.summary.total_sales)}</div>
                    <div class="change-indicator change-neutral">全販路合計</div>
                </div>
                <div class="summary-card profit">
                    <h3>総利益</h3>
                    <div class="value">¥${formatLargeNumber(result.summary.total_profit)}</div>
                    <div class="change-indicator change-positive">利益合計</div>
                </div>
                <div class="summary-card rate">
                    <h3>平均利益率</h3>
                    <div class="value">${result.summary.average_profit_rate.toFixed(1)}%</div>
                    <div class="change-indicator ${result.summary.average_profit_rate >= 20 ? 'change-positive' : result.summary.average_profit_rate >= 10 ? 'change-neutral' : 'change-negative'}">
                        ${result.summary.average_profit_rate >= 20 ? '優秀' : result.summary.average_profit_rate >= 10 ? '良好' : '改善余地あり'}
                    </div>
                </div>
            `;

            // スプレッドシートデータ表示
            const monthlyData = document.getElementById('monthly-data');
            monthlyData.innerHTML = '';
            
            if (result.spreadsheet_data && result.spreadsheet_data.length > 0) {
                // スプレッドシート形式で表示
                result.spreadsheet_data.forEach(rowData => {
                    const monthItem = document.createElement('div');
                    monthItem.className = 'month-item';
                    
                    // 売上高セクション
                    const salesItems = [
                        { label: 'Amazon（A-M）', value: rowData['Amazon（A-M）'] },
                        { label: 'Amazon2（O-AA）', value: rowData['Amazon2（O-AA）'] },
                        { label: 'メルカリShops', value: rowData['メルカリShops'] },
                        { label: 'バンコ+（楽天）', value: rowData['バンコ+（楽天）'] },
                        { label: 'Yahoo!ショッピング', value: rowData['Yahoo!ショッピング'] },
                        { label: 'プリマアプリ', value: rowData['プリマアプリ'] }
                    ];
                    
                    // 経費セクション
                    const expenseItems = [
                        { label: 'プラットフォーム手数料_Amazon', value: rowData['プラットフォーム手数料_Amazon'] },
                        { label: 'プラットフォーム手数料_Amazon2', value: rowData['プラットフォーム手数料_Amazon2'] },
                        { label: 'プラットフォーム手数料_メルカリ', value: rowData['プラットフォーム手数料_メルカリ'] },
                        { label: '運送費（送料）', value: rowData['運送費（送料）'] }
                    ];
                    
                    // 利益セクション
                    const profitItems = [
                        { label: '売上総利益', value: rowData['売上総利益'] },
                        { label: '売上高合計', value: rowData['売上高合計'] }
                    ];
                    
                    // HTMLを構築
                    let sectionsHtml = '';
                    
                    // 売上高セクション
                    const salesHtml = salesItems.filter(item => item.value > 0)
                        .map(item => `<div class="data-item"><span class="data-label">${item.label}</span><span class="data-value">¥${item.value.toLocaleString()}</span></div>`)
                        .join('');
                    if (salesHtml) {
                        sectionsHtml += `<div class="section-title">売上高</div>${salesHtml}`;
                    }
                    
                    // 経費セクション  
                    const expenseHtml = expenseItems.filter(item => item.value > 0)
                        .map(item => `<div class="data-item"><span class="data-label">${item.label}</span><span class="data-value">¥${item.value.toLocaleString()}</span></div>`)
                        .join('');
                    if (expenseHtml) {
                        sectionsHtml += `<div class="section-title">経費</div>${expenseHtml}`;
                    }
                    
                    // 利益セクション
                    const profitHtml = profitItems.filter(item => item.value > 0)
                        .map(item => `<div class="data-item"><span class="data-label">${item.label}</span><span class="data-value">¥${item.value.toLocaleString()}</span></div>`)
                        .join('');
                    if (profitHtml) {
                        sectionsHtml += `<div class="section-title">利益</div>${profitHtml}`;
                    }
                    
                    monthItem.innerHTML = `
                        <div class="month-header">${rowData['年月']}</div>
                        <div class="month-data">${sectionsHtml}</div>
                    `;
                    
                    monthlyData.appendChild(monthItem);
                });
            } else {
                // フォールバック: 従来の表示
                Object.entries(result.results).forEach(([month, data]) => {
                    const monthItem = document.createElement('div');
                    monthItem.className = 'month-item';
                    
                    let dataItems = '';
                    Object.entries(data).forEach(([key, value]) => {
                        if (value > 0) {
                            dataItems += `
                                <div class="data-item">
                                    <span class="data-label">${key}</span>
                                    <span class="data-value">¥${value.toLocaleString()}</span>
                                </div>
                            `;
                        }
                    });

                    monthItem.innerHTML = `
                        <div class="month-header">${month}</div>
                        <div class="month-data">${dataItems}</div>
                    `;
                    
                    monthlyData.appendChild(monthItem);
                });
            }

            // トレンドグラフを表示
            displayTrendChart(result);
            
            // 結果セクションを表示
            document.getElementById('results').style.display = 'block';
            
            // 保存済みデータリストを更新
            loadSavedDataList();
        }
        
        // トレンドグラフ表示
        function displayTrendChart(result) {
            try {
                const trendSection = document.getElementById('trend-section');
                const trendChart = document.getElementById('trend-chart');
                
                if (result.spreadsheet_data && result.spreadsheet_data.length > 1) {
                    trendSection.style.display = 'block';
                    
                    // 最大値を取得して正規化
                    const salesValues = result.spreadsheet_data.map(row => row['売上高合計'] || 0);
                    const maxSales = Math.max(...salesValues);
                    
                    trendChart.innerHTML = '';
                    
                    result.spreadsheet_data.forEach(rowData => {
                        const sales = rowData['売上高合計'] || 0;
                        const height = maxSales > 0 ? Math.max((sales / maxSales * 100), 5) : 10;
                        
                        const bar = document.createElement('div');
                        bar.className = 'trend-bar';
                        bar.style.height = height + '%';
                        
                        const monthDisplay = (rowData['年月'] || '未設定').replace('年', '/').replace('月', '');
                        
                        bar.innerHTML = `
                            <div class="trend-bar-label">${monthDisplay}</div>
                            <div class="trend-bar-value">¥${formatLargeNumber(sales)}</div>
                        `;
                        
                        trendChart.appendChild(bar);
                    });
                } else {
                    trendSection.style.display = 'none';
                }
            } catch (error) {
                console.warn('トレンドグラフ表示エラー:', error);
                document.getElementById('trend-section').style.display = 'none';
            }
        }

        // 数値フォーマット関数
        function formatNumber(num) {
            return new Intl.NumberFormat('ja-JP').format(num);
        }
        
        // 大きな数値を簡潔に表示
        function formatLargeNumber(num) {
            if (num >= 10000000) {
                return (num / 10000000).toFixed(1) + '千万';
            } else if (num >= 10000) {
                return (num / 10000).toFixed(1) + '万';
            } else {
                return num.toLocaleString();
            }
        }
        
        // パーセンテージのカラークラスを取得
        function getPercentageClass(percentage) {
            if (percentage > 0) return 'change-positive';
            if (percentage < 0) return 'change-negative';
            return 'change-neutral';
        }

        // 保存済みデータリストを読み込み
        async function loadSavedDataList() {
            try {
                const response = await fetch('/api/months');
                const result = await response.json();
                
                if (result.success) {
                    const savedMonths = result.months.filter(month => month.has_data);
                    displaySavedDataList(savedMonths);
                    
                    // 保存済みデータがある場合はセクションを表示
                    const section = document.getElementById('saved-data-section');
                    if (savedMonths.length > 0) {
                        section.style.display = 'block';
                    } else {
                        section.style.display = 'none';
                    }
                } else {
                    showMessage('保存済みデータの読み込みに失敗しました', 'error');
                }
            } catch (error) {
                console.error('保存済みデータ読み込みエラー:', error);
            }
        }

        // 保存済みデータリストを表示
        function displaySavedDataList(savedMonths) {
            const listContainer = document.getElementById('saved-data-list');
            listContainer.innerHTML = '';
            
            if (savedMonths.length === 0) {
                listContainer.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">保存済みデータはありません</p>';
                return;
            }
            
            savedMonths.forEach(month => {
                const item = document.createElement('div');
                item.className = 'saved-data-item';
                
                item.innerHTML = `
                    <div class="saved-data-title">${month.display}</div>
                    <div class="saved-data-summary">データ保存済み (${month.key})</div>
                    <div class="saved-data-actions">
                        <button class="btn-small btn-view" onclick="viewMonthData('${month.key}')">
                            詳細表示
                        </button>
                        <button class="btn-small btn-export" onclick="exportMonthData('${month.key}')">
                            エクスポート
                        </button>
                        <button class="btn-small btn-delete" onclick="deleteMonthData('${month.key}')">
                            削除
                        </button>
                    </div>
                `;
                
                listContainer.appendChild(item);
            });
        }

        // 月別データを表示
        async function viewMonthData(monthKey) {
            try {
                showLoading(true);
                const response = await fetch(`/api/months/${monthKey}`);
                const result = await response.json();
                
                if (result.success) {
                    // 既存の結果表示関数を使用
                    const mockResult = {
                        success: true,
                        message: `${result.display_name}のデータを表示しました`,
                        target_month: monthKey,
                        results: result.data.results,
                        spreadsheet_data: result.data.spreadsheet_data,
                        summary: {
                            total_months: 1,
                            total_sales: result.data.spreadsheet_data.reduce((sum, row) => sum + (row['売上高合計'] || 0), 0),
                            total_profit: result.data.spreadsheet_data.reduce((sum, row) => sum + (row['売上総利益'] || 0), 0),
                            average_profit_rate: 0
                        }
                    };
                    
                    // 利益率を計算
                    if (mockResult.summary.total_sales > 0) {
                        mockResult.summary.average_profit_rate = (mockResult.summary.total_profit / mockResult.summary.total_sales) * 100;
                    }
                    
                    displayResults(mockResult);
                    showMessage(`${result.display_name}のデータを表示しました`, 'success');
                } else {
                    showMessage(`データ表示エラー: ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage(`データ表示エラー: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // 月別データをエクスポート
        async function exportMonthData(monthKey) {
            try {
                const response = await fetch(`/api/months/${monthKey}/spreadsheet`);
                const result = await response.json();
                
                if (result.success) {
                    // CSVデータを生成
                    const csvData = convertToCSV(result.spreadsheet_data);
                    downloadCSV(csvData, `${monthKey}_データ.csv`);
                    showMessage(`${result.display_name}のデータをエクスポートしました`, 'success');
                } else {
                    showMessage(`エクスポートエラー: ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage(`エクスポートエラー: ${error.message}`, 'error');
            }
        }

        // 月別データを削除
        async function deleteMonthData(monthKey) {
            if (!confirm(`${monthKey}のデータを削除しますか？この操作は取り消せません。`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/months/${monthKey}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                
                if (result.success) {
                    showMessage(result.message, 'success');
                    // リストを再読み込み
                    loadSavedDataList();
                    loadMonthsList();
                } else {
                    showMessage(`削除エラー: ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage(`削除エラー: ${error.message}`, 'error');
            }
        }

        // 全データをエクスポート
        async function exportAllData() {
            try {
                showLoading(true);
                const response = await fetch('/api/months');
                const result = await response.json();
                
                if (result.success) {
                    const savedMonths = result.months.filter(month => month.has_data);
                    
                    if (savedMonths.length === 0) {
                        showMessage('エクスポートするデータがありません', 'error');
                        return;
                    }
                    
                    let allData = [];
                    
                    for (const month of savedMonths) {
                        const monthResponse = await fetch(`/api/months/${month.key}/spreadsheet`);
                        const monthResult = await monthResponse.json();
                        
                        if (monthResult.success) {
                            allData = allData.concat(monthResult.spreadsheet_data);
                        }
                    }
                    
                    if (allData.length > 0) {
                        const csvData = convertToCSV(allData);
                        downloadCSV(csvData, '全データ_一括エクスポート.csv');
                        showMessage(`${savedMonths.length}ヶ月分のデータをエクスポートしました`, 'success');
                    } else {
                        showMessage('エクスポート可能なデータがありません', 'error');
                    }
                } else {
                    showMessage(`エクスポートエラー: ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage(`エクスポートエラー: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // CSVデータに変換
        function convertToCSV(data) {
            if (!data || data.length === 0) return '';
            
            const headers = Object.keys(data[0]);
            const csvRows = [headers.join(',')];
            
            data.forEach(row => {
                const values = headers.map(header => {
                    const value = row[header];
                    // 値に改行やカンマが含まれる場合はダブルクォートで囲む
                    if (typeof value === 'string' && (value.includes(',') || value.includes('\n') || value.includes('"'))) {
                        return `"${value.replace(/"/g, '""')}"`;
                    }
                    return value;
                });
                csvRows.push(values.join(','));
            });
            
            return csvRows.join('\n');
        }

        // CSVファイルをダウンロード
        function downloadCSV(csvData, filename) {
            const blob = new Blob(['\uFEFF' + csvData], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>