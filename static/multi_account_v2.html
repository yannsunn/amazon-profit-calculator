<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSVåˆ©ç›Šãƒ»çµŒè²»è¨ˆç®—ãƒ„ãƒ¼ãƒ«ï¼ˆè¤‡æ•°ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå¯¾å¿œç‰ˆï¼‰</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
        }
        .file-input-label {
            transition: all 0.2s ease-in-out;
            background-color: #f9fafb;
        }
        .file-input-label:hover {
            background-color: #f3f4f6;
            border-color: #6366f1;
        }
        .toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 50;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            opacity: 0;
            transition: visibility 0s, opacity 0.5s linear;
        }
        .toast.show {
            visibility: visible;
            opacity: 1;
        }
        .summary-card {
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
        }
        details > summary {
            cursor: pointer;
            list-style: none;
        }
        details > summary::-webkit-details-marker {
            display: none;
        }
        .platform-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .platform-tab {
            padding: 10px 20px;
            background: #f3f4f6;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .platform-tab:hover {
            background: #e5e7eb;
        }
        .platform-tab.active {
            background: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }
        .platform-content {
            display: none;
        }
        .platform-content.active {
            display: block;
        }
        .swap-button {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
            background: #ef4444;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .swap-button:hover {
            background: #dc2626;
            transform: scale(1.05);
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <!-- Swap Button -->
    <button id="swapAccountsBtn" class="swap-button">
        ğŸ”„ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ1â†”2å…¥æ›¿
    </button>

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-7xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">CSV åˆ©ç›Šãƒ»çµŒè²»è¨ˆç®—ãƒ„ãƒ¼ãƒ«</h1>
            <p class="mt-2 text-gray-600">å„è²©è·¯ã®CSVã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦åæ”¯ã‚’è¨ˆç®—ã—ã¾ã™ã€‚</p>
        </header>

        <main>
            <!-- Platform Tabs -->
            <div class="platform-tabs">
                <button class="platform-tab active" data-platform="amazon">Amazon</button>
                <button class="platform-tab" data-platform="mercari">ãƒ¡ãƒ«ã‚«ãƒªShops</button>
            </div>

            <!-- File Upload Section -->
            <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                <h2 class="text-xl font-semibold mb-4 border-b pb-2">1. CSVãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
                
                <!-- Amazon Content -->
                <div id="amazon-content" class="platform-content active">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-8">
                        <!-- Account 1 -->
                        <div class="p-4 border rounded-lg space-y-4">
                            <h3 class="font-semibold text-lg text-center text-indigo-700">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ 1</h3>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ãƒã‚«ãƒ‰CSV</label>
                                <label for="makadFile1" class="file-input-label flex justify-center w-full px-4 py-4 border-2 border-gray-300 border-dashed rounded-md cursor-pointer">
                                    <div class="text-center"><p id="fileNameMakad1" class="text-sm text-gray-600 font-medium">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</p></div>
                                    <input id="makadFile1" type="file" class="hidden" accept=".csv">
                                </label>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">hanro+ CSV</label>
                                <label for="hanroFile1" class="file-input-label flex justify-center w-full px-4 py-4 border-2 border-gray-300 border-dashed rounded-md cursor-pointer">
                                    <div class="text-center"><p id="fileNameHanro1" class="text-sm text-gray-600 font-medium">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</p></div>
                                    <input id="hanroFile1" type="file" class="hidden" accept=".csv">
                                </label>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">AmazonçµŒè²»CSV</label>
                                <label for="amazonFile1" class="file-input-label flex justify-center w-full px-4 py-4 border-2 border-gray-300 border-dashed rounded-md cursor-pointer">
                                    <div class="text-center"><p id="fileNameAmazon1" class="text-sm text-gray-600 font-medium">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</p></div>
                                    <input id="amazonFile1" type="file" class="hidden" accept=".csv">
                                </label>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Amazonåºƒå‘ŠCSV</label>
                                <label for="adFile1" class="file-input-label flex justify-center w-full px-4 py-4 border-2 border-gray-300 border-dashed rounded-md cursor-pointer">
                                    <div class="text-center"><p id="fileNameAd1" class="text-sm text-gray-600 font-medium">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</p></div>
                                    <input id="adFile1" type="file" class="hidden" accept=".csv">
                                </label>
                            </div>
                        </div>
                        <!-- Account 2 -->
                        <div class="p-4 border rounded-lg space-y-4">
                            <h3 class="font-semibold text-lg text-center text-teal-700">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ 2</h3>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ãƒã‚«ãƒ‰CSV</label>
                                <label for="makadFile2" class="file-input-label flex justify-center w-full px-4 py-4 border-2 border-gray-300 border-dashed rounded-md cursor-pointer">
                                    <div class="text-center"><p id="fileNameMakad2" class="text-sm text-gray-600 font-medium">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</p></div>
                                    <input id="makadFile2" type="file" class="hidden" accept=".csv">
                                </label>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">hanro+ CSV</label>
                                <label for="hanroFile2" class="file-input-label flex justify-center w-full px-4 py-4 border-2 border-gray-300 border-dashed rounded-md cursor-pointer">
                                    <div class="text-center"><p id="fileNameHanro2" class="text-sm text-gray-600 font-medium">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</p></div>
                                    <input id="hanroFile2" type="file" class="hidden" accept=".csv">
                                </label>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">AmazonçµŒè²»CSV</label>
                                <label for="amazonFile2" class="file-input-label flex justify-center w-full px-4 py-4 border-2 border-gray-300 border-dashed rounded-md cursor-pointer">
                                    <div class="text-center"><p id="fileNameAmazon2" class="text-sm text-gray-600 font-medium">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</p></div>
                                    <input id="amazonFile2" type="file" class="hidden" accept=".csv">
                                </label>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Amazonåºƒå‘ŠCSV</label>
                                <label for="adFile2" class="file-input-label flex justify-center w-full px-4 py-4 border-2 border-gray-300 border-dashed rounded-md cursor-pointer">
                                    <div class="text-center"><p id="fileNameAd2" class="text-sm text-gray-600 font-medium">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</p></div>
                                    <input id="adFile2" type="file" class="hidden" accept=".csv">
                                </label>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- Mercari Content -->
                <div id="mercari-content" class="platform-content">
                    <div class="p-4 border rounded-lg space-y-4 max-w-md mx-auto">
                        <h3 class="font-semibold text-lg text-center text-rose-700">ãƒ¡ãƒ«ã‚«ãƒªShops ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</h3>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ãƒ¡ãƒ«ã‚«ãƒªShops CSV</label>
                            <label for="mercariFile" class="file-input-label flex justify-center w-full px-4 py-4 border-2 border-gray-300 border-dashed rounded-md cursor-pointer">
                                <div class="text-center"><p id="fileNameMercari" class="text-sm text-gray-600 font-medium">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</p></div>
                                <input id="mercariFile" type="file" class="hidden" accept=".csv">
                            </label>
                        </div>
                    </div>
                </div>

                <div class="mt-8 text-center">
                    <button id="processBtn" class="w-full md:w-auto bg-indigo-600 text-white font-semibold py-3 px-8 rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-colors duration-200 disabled:bg-gray-400">
                        å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹
                    </button>
                </div>
            </div>

            <!-- Results Section -->
            <div id="resultsContainer" class="space-y-12">
                <div id="finalSummaryResult"></div>
                <div id="grandTotalResult"></div>
                <div id="resultAccount1"></div>
                <div id="resultAccount2"></div>
                <div id="resultMercari"></div>
            </div>
        </main>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        // Initialize platform tabs
        const platformTabs = document.querySelectorAll('.platform-tab');
        const platformContents = document.querySelectorAll('.platform-content');
        
        platformTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const platform = tab.dataset.platform;
                
                // Update active states
                platformTabs.forEach(t => t.classList.remove('active'));
                platformContents.forEach(c => c.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(`${platform}-content`).classList.add('active');
            });
        });

        // File inputs configuration
        const inputs = {
            acc1: { 
                makad: { file: document.getElementById('makadFile1'), name: document.getElementById('fileNameMakad1') }, 
                hanro: { file: document.getElementById('hanroFile1'), name: document.getElementById('fileNameHanro1') }, 
                amazon: { file: document.getElementById('amazonFile1'), name: document.getElementById('fileNameAmazon1') }, 
                ad: { file: document.getElementById('adFile1'), name: document.getElementById('fileNameAd1') }, 
                container: document.getElementById('resultAccount1') 
            },
            acc2: { 
                makad: { file: document.getElementById('makadFile2'), name: document.getElementById('fileNameMakad2') }, 
                hanro: { file: document.getElementById('hanroFile2'), name: document.getElementById('fileNameHanro2') },
                amazon: { file: document.getElementById('amazonFile2'), name: document.getElementById('fileNameAmazon2') }, 
                ad: { file: document.getElementById('adFile2'), name: document.getElementById('fileNameAd2') }, 
                container: document.getElementById('resultAccount2') 
            },
            mercari: {
                sales: { file: document.getElementById('mercariFile'), name: document.getElementById('fileNameMercari') },
                container: document.getElementById('resultMercari')
            }
        };

        const processBtn = document.getElementById('processBtn');
        const toast = document.getElementById('toast');
        const swapBtn = document.getElementById('swapAccountsBtn');

        let processedDataStore = {};

        // Setup file input listeners
        Object.values(inputs).forEach(acc => {
            Object.values(acc).forEach(input => {
                if (input.file) {
                    input.file.addEventListener('change', () => {
                        input.name.textContent = input.file.files.length > 0 ? input.file.files[0].name : 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ';
                    });
                    setupDragDrop(input.file, input.file.parentElement, input.name);
                }
            });
        });

        // Swap accounts functionality
        swapBtn.addEventListener('click', () => {
            // Swap files for each input type
            Object.keys(inputs.acc1).forEach(key => {
                if (key !== 'container' && inputs.acc1[key].file && inputs.acc2[key].file) {
                    // Swap files
                    const tempFiles = inputs.acc1[key].file.files;
                    const tempName = inputs.acc1[key].name.textContent;
                    
                    inputs.acc1[key].file.files = inputs.acc2[key].file.files;
                    inputs.acc1[key].name.textContent = inputs.acc2[key].name.textContent;
                    
                    inputs.acc2[key].file.files = tempFiles;
                    inputs.acc2[key].name.textContent = tempName;
                }
            });
            
            showToast('ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ1ã¨2ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…¥ã‚Œæ›¿ãˆã¾ã—ãŸ');
        });
        
        // Drag and drop setup
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => { 
            document.body.addEventListener(eventName, e => { 
                e.preventDefault(); 
                e.stopPropagation(); 
            }); 
        });

        function setupDragDrop(inputElement, labelElement, nameElement) {
            labelElement.addEventListener('drop', e => {
                e.preventDefault(); 
                e.stopPropagation();
                inputElement.files = e.dataTransfer.files;
                nameElement.textContent = inputElement.files[0].name;
                labelElement.classList.remove('border-indigo-500', 'bg-indigo-50');
            });
            labelElement.addEventListener('dragenter', (e) => {
                e.preventDefault(); 
                e.stopPropagation();
                labelElement.classList.add('border-indigo-500', 'bg-indigo-50');
            });
            labelElement.addEventListener('dragleave', (e) => {
                e.preventDefault(); 
                e.stopPropagation();
                labelElement.classList.remove('border-indigo-500', 'bg-indigo-50');
            });
        }

        function showToast(message) {
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => { toast.classList.remove('show'); }, 3000);
        }

        function parseCsv(file, encoding = 'UTF-8') {
            return new Promise((resolve, reject) => {
                if (!file) {
                    resolve({data: [], meta: { fields: [] }});
                    return;
                }
                Papa.parse(file, {
                    encoding: encoding,
                    header: true,
                    skipEmptyLines: true,
                    transformHeader: header => header.trim().replace(/^\uFEFF/, ''),
                    complete: (results) => resolve(results),
                    error: (error) => reject(error)
                });
            });
        }

        const safeNumber = (val) => {
            if (val === null || val === undefined) return 0;
            const cleanString = String(val).replace(/,|Â¥|å††/g, '');
            return Number(cleanString) || 0;
        };
        
        const HEADER_MAP = {
            makadOrderDate: ['æ³¨æ–‡æ—¥'], makadProductName: ['å•†å“å'], makadAsin: ['ASIN'], makadSku: ['SKU'], 
            makadShippingRoute: ['é…é€çµŒè·¯'], makadSalesPrice: ['è²©å£²ä¾¡æ ¼'], makadShippingFee: ['é€æ–™'], 
            makadPoints: ['ãƒã‚¤ãƒ³ãƒˆ'], makadDiscount: ['å‰²å¼•'], makadCostPrice: ['ä»•å…¥ã‚Œä¾¡æ ¼'], 
            makadAmazonFee: ['Amazonæ‰‹æ•°æ–™'], makadGrossProfit: ['ç²—åˆ©'],
            hanroOrderedAt: ['orderedAt'], hanroSku: ['sku'], hanroItemTitle: ['itemTitle'], 
            hanroQuantity: ['quantity'], hanroAmount: ['amount'], hanroShipmentFee: ['shipmentFee'], 
            hanroCost: ['cost'], hanroProfit: ['profit'], hanroAmazonStatus: ['amazonStatus'],
            mercariPurchaseDate: ['è³¼å…¥æ—¥'], mercariCancelDate: ['ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ—¥'], mercariProductName: ['å•†å“å'], 
            mercariQuantity: ['æ•°é‡'], mercariSalesProfit: ['è²©å£²åˆ©ç›Š'], mercariSales: ['å£²ä¸Šï¼ˆç¨è¾¼ï¼‰'], 
            mercariFee: ['è²©å£²æ‰‹æ•°æ–™ï¼ˆç¨è¾¼ï¼‰'],
            amazonTransactionType: ['ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®ç¨®é¡'], amazonTransactionDate: ['æ—¥ä»˜/æ™‚é–“', 'æ—¥ä»˜ï¼æ™‚é–“'], 
            amazonTotal: ['åˆè¨ˆ'], amazonDescription: ['èª¬æ˜'],
            adSpend: ['æ”¯å‡º', 'æ”¯å‡º(æ›ç®—æ¸ˆã¿)', 'æ”¯å‡º (æ›ç®—æ¸ˆã¿)'],
        };
        
        const normalize = (str) => (str || '').replace(/[\s\u3000()ï¼ˆï¼‰]/g, '').toLowerCase();

        function getColumnMapper(actualHeaders) {
            const mapping = {};
            for (const internalName in HEADER_MAP) {
                const possibleNames = HEADER_MAP[internalName];
                for (const pName of possibleNames) {
                    const normalizedPName = normalize(pName);
                    const foundHeader = actualHeaders.find(h => normalize(h) === normalizedPName);
                    if (foundHeader) {
                        mapping[internalName] = foundHeader;
                        break;
                    }
                }
            }
            return (row, internalName) => {
                const header = mapping[internalName];
                return header ? row[header] : undefined;
            };
        }

        async function processAccountData(makadFile, hanroFile, amazonFile, adFile) {
            const hasAnyFile = makadFile || hanroFile || amazonFile || adFile;
            if (!hasAnyFile) return null;

            const [makadResults, hanroResults, amazonResults, adResults] = await Promise.all([
                parseCsv(makadFile, 'Shift_JIS'),
                parseCsv(hanroFile, 'Shift_JIS'),
                parseCsv(amazonFile, 'UTF-8'),
                parseCsv(adFile, 'UTF-8')
            ]);
            
            const makadData = makadResults.data;
            const hanroData = hanroResults.data;
            const amazonData = amazonResults.data;
            const adData = adResults.data;

            if (makadData.length === 0 && hanroData.length === 0 && amazonData.length === 0 && adData.length === 0) return null;

            let totalSales = 0;
            let totalGrossProfit = 0;
            let allOrderDetails = [];
            const platformSummaries = {};
            const expenseSummary = {};
            
            if (makadData.length > 0 || hanroData.length > 0) {
                const getMakadValue = getColumnMapper(makadResults.meta.fields);
                const getHanroValue = getColumnMapper(hanroResults.meta.fields);

                const costLookup = {};
                makadData.forEach(row => {
                    const sku = getMakadValue(row, 'makadSku');
                    const cost = safeNumber(getMakadValue(row, 'makadCostPrice'));
                    if (sku && cost > 0 && !costLookup[sku]) {
                        costLookup[sku] = cost;
                    }
                });

                const makadOrderDetails = makadData.map(row => ({
                    'æ³¨æ–‡æ—¥æ™‚': getMakadValue(row, 'makadOrderDate') || '', 
                    'è²©å£²çµŒè·¯': 'ãƒã‚«ãƒ‰', 
                    'SKU': getMakadValue(row, 'makadSku') || '', 
                    'å•†å“å': getMakadValue(row, 'makadProductName') || '', 
                    'è²©å£²é‡‘é¡': safeNumber(getMakadValue(row, 'makadSalesPrice')), 
                    'æ‰‹æ•°æ–™': safeNumber(getMakadValue(row, 'makadAmazonFee')), 
                    'ä»•å…¥ã‚Œä¾¡æ ¼': safeNumber(getMakadValue(row, 'makadCostPrice')), 
                    'ç²—åˆ©': safeNumber(getMakadValue(row, 'makadGrossProfit')), 
                    'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹': '',
                }));

                const hanroOrderDetails = hanroData
                    .filter(row => getHanroValue(row, 'hanroAmazonStatus') !== 'FAILED')
                    .map(row => {
                        const sku = getHanroValue(row, 'hanroSku');
                        let cost = safeNumber(getHanroValue(row, 'hanroCost'));
                        if (cost === 0 && sku && costLookup[sku]) {
                            cost = costLookup[sku];
                        }
                        const amount = safeNumber(getHanroValue(row, 'hanroAmount'));
                        const fee = safeNumber(getHanroValue(row, 'hanroShipmentFee'));
                        const profit = amount - fee - cost;
                        return {
                            'æ³¨æ–‡æ—¥æ™‚': getHanroValue(row, 'hanroOrderedAt') || '', 
                            'è²©å£²çµŒè·¯': 'hanro+', 
                            'SKU': sku || '', 
                            'å•†å“å': getHanroValue(row, 'hanroItemTitle') || '', 
                            'è²©å£²é‡‘é¡': amount, 
                            'æ‰‹æ•°æ–™': fee, 
                            'ä»•å…¥ã‚Œä¾¡æ ¼': cost, 
                            'ç²—åˆ©': profit, 
                            'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹': getHanroValue(row, 'hanroAmazonStatus') || '',
                        };
                    });
                
                allOrderDetails = [...makadOrderDetails, ...hanroOrderDetails];

                allOrderDetails.forEach(order => {
                    const platform = order['è²©å£²çµŒè·¯'];
                    if (!platformSummaries[platform]) {
                        platformSummaries[platform] = { sales: 0, profit: 0, fees: 0, cost: 0 };
                    }
                    platformSummaries[platform].sales += order['è²©å£²é‡‘é¡'];
                    platformSummaries[platform].profit += order['ç²—åˆ©'];
                    platformSummaries[platform].fees += order['æ‰‹æ•°æ–™'];
                    platformSummaries[platform].cost += order['ä»•å…¥ã‚Œä¾¡æ ¼'];
                });

                totalSales = allOrderDetails.reduce((sum, row) => sum + row['è²©å£²é‡‘é¡'], 0);
                totalGrossProfit = allOrderDetails.reduce((sum, row) => sum + row['ç²—åˆ©'], 0);
            }

            if (amazonData.length > 0) {
                const getAmazonValue = getColumnMapper(amazonResults.meta.fields);
                const expenseKeywords = [ 
                    'FBAåœ¨åº«ä¿ç®¡æ‰‹æ•°æ–™', 'FBAé•·æœŸåœ¨åº«ä¿ç®¡æ‰‹æ•°æ–™', 'FBAåœ¨åº«ã®è¿”é€æ‰‹æ•°æ–™', 
                    'FBAåœ¨åº«ã®è¿”é‡‘', 'FBAãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚­ãƒ£ãƒªã‚¢', 'FBAãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚­ãƒ£ãƒªã‚¢ã®é…é€æ–™', 
                    'Amazon çµŒç”±ã§è³¼å…¥ã—ãŸé…é€ãƒ©ãƒ™ãƒ«' 
                ];
                amazonData.forEach(row => {
                    const transactionType = (getAmazonValue(row, 'amazonTransactionType') || '').trim();
                    const description = (getAmazonValue(row, 'amazonDescription') || '').trim();
                    const amount = safeNumber(getAmazonValue(row, 'amazonTotal'));
                    
                    const matchedKeyword = expenseKeywords.find(keyword => 
                        transactionType.includes(keyword) || description.includes(keyword)
                    );
                    
                    if (matchedKeyword) {
                        if (!expenseSummary[matchedKeyword]) { expenseSummary[matchedKeyword] = 0; }
                        expenseSummary[matchedKeyword] += amount;
                    }
                });
            }

            if (adData.length > 0) {
                const getAdValue = getColumnMapper(adResults.meta.fields);
                const adSpendTotal = adData.reduce((sum, row) => sum + safeNumber(getAdValue(row, 'adSpend')), 0);
                if (adSpendTotal !== 0) {
                    expenseSummary['Amazonåºƒå‘Šè²»'] = -adSpendTotal;
                }
            }
            
            const totalExpenses = Object.values(expenseSummary).reduce((sum, val) => sum + val, 0);
            const finalProfit = totalGrossProfit + totalExpenses;
            
            return {
                accountSummary: { totalSales, totalGrossProfit, totalExpenses, finalProfit },
                platformSummaries,
                orderDetails: allOrderDetails,
                expenseSummary
            };
        }

        function renderFinalSummary(allData) {
            const container = document.getElementById('finalSummaryResult');
            container.innerHTML = '';
            
            const validData = allData.filter(d => d && d.accountSummary);
            if (validData.length < 1) return;

            const sales = {};
            const fees = {};
            const expenses = {};
            let totalCost = 0;

            allData.forEach((data, index) => {
                if (!data) return;
                const accName = index === 0 ? " (ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ1)" : index === 1 ? " (ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ2)" : "";
                
                if (data.platformSummaries) {
                    for(const [platform, summary] of Object.entries(data.platformSummaries)) {
                        sales[platform + accName] = summary.sales;
                        fees[platform + accName] = summary.fees;
                        totalCost += summary.cost;
                    }
                }
                if (data.expenseSummary && Object.keys(data.expenseSummary).length > 0) {
                     for(const [expense, amount] of Object.entries(data.expenseSummary)) {
                         expenses[expense + accName] = amount;
                     }
                } else if(index === 2 && data.accountSummary.totalExpenses !== 0) { // Mercari
                     expenses["é…é€æ–™" + accName] = data.accountSummary.totalExpenses;
                }
            });
            
            const renderList = (title, data) => {
                if (Object.keys(data).length === 0) return '';
                return `
                    <div class="p-4 border rounded-lg">
                        <h4 class="font-semibold text-lg mb-2 text-center">${title}</h4>
                        <ul class="divide-y">${Object.entries(data).map(([key, value]) => `<li class="py-1 flex justify-between"><span>${key}</span><span>${value.toLocaleString()}å††</span></li>`).join('')}</ul>
                    </div>`;
            };

            container.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h3 class="text-2xl font-bold mb-4 text-center">é …ç›®åˆ¥ åˆè¨ˆã‚µãƒãƒªãƒ¼</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${renderList('å„å£²ä¸Š', sales)}
                        ${renderList('å„æ‰‹æ•°æ–™', fees)}
                        ${renderList('å„çµŒè²»', expenses)}
                    </div>
                     <div class="mt-6 pt-4 border-t text-center">
                        <h4 class="font-semibold text-lg mb-2">ä»•å…¥ã‚Œå€¤ åˆè¨ˆ</h4>
                        <p class="text-2xl font-bold text-gray-800">${totalCost.toLocaleString()}å††</p>
                    </div>
                </div>`;
        }
        
        async function processMercariData(mercariFile) {
            if (!mercariFile) return null;

            const mercariResults = await parseCsv(mercariFile, 'Shift_JIS');
            const mercariData = mercariResults.data;
            if (mercariData.length === 0) return null;
            
            const getMercariValue = getColumnMapper(mercariResults.meta.fields);
            
            let totalShipping = 0;
            const orderDetails = mercariData
                .filter(row => !getMercariValue(row, 'mercariCancelDate'))
                .map(row => {
                    const quantity = safeNumber(getMercariValue(row, 'mercariQuantity'));
                    const shippingFee = 550 * quantity;
                    totalShipping += shippingFee;
                    const sales = safeNumber(getMercariValue(row, 'mercariSales'));
                    const fee = safeNumber(getMercariValue(row, 'mercariFee'));
                    const profit = sales - fee - shippingFee;
                    return {
                        'æ³¨æ–‡æ—¥æ™‚': getMercariValue(row, 'mercariPurchaseDate') || '', 
                        'è²©å£²çµŒè·¯': 'ãƒ¡ãƒ«ã‚«ãƒªShops', 
                        'SKU': '', 
                        'å•†å“å': getMercariValue(row, 'mercariProductName') || '', 
                        'è²©å£²é‡‘é¡': sales, 
                        'æ‰‹æ•°æ–™': fee + shippingFee, 
                        'ä»•å…¥ã‚Œä¾¡æ ¼': 0, 
                        'ç²—åˆ©': profit, 
                        'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹': 'è³¼å…¥',
                    };
                });

            const totalSales = orderDetails.reduce((sum, row) => sum + row['è²©å£²é‡‘é¡'], 0);
            const totalGrossProfit = orderDetails.reduce((sum, row) => sum + row['ç²—åˆ©'], 0);
            const totalFees = orderDetails.reduce((sum, row) => sum + row['æ‰‹æ•°æ–™'], 0);
            
            const expenseSummary = {};
            if (totalShipping > 0) {
                expenseSummary['é…é€æ–™'] = -totalShipping;
            }

            return {
                accountSummary: { totalSales, totalGrossProfit, totalExpenses: -totalShipping, finalProfit: totalGrossProfit },
                platformSummaries: { 'ãƒ¡ãƒ«ã‚«ãƒªShops': { sales: totalSales, profit: totalGrossProfit, fees: totalFees, cost: 0 } },
                orderDetails: orderDetails,
                expenseSummary
            };
        }

        function renderAccountResults(container, data, accountName) {
            if (!container) return;
            container.innerHTML = '';
            if (!data || !data.accountSummary) { 
                container.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-md text-center text-gray-500">${accountName}ã®ãƒ‡ãƒ¼ã‚¿ã¯å‡¦ç†ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚</div>`;
                return; 
            }
            const { accountSummary, platformSummaries, orderDetails, expenseSummary } = data;
            const finalProfitColor = accountSummary.finalProfit >= 0 ? 'text-green-600' : 'text-red-600';

            container.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold mb-6 text-center">${accountName} é›†è¨ˆçµæœ</h2>
                    <details class="border rounded-lg p-4 mb-8" open>
                        <summary class="font-semibold text-xl flex justify-between items-center">
                            <span>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚µãƒãƒªãƒ¼</span>
                            <span class="text-sm text-gray-500">ã‚¯ãƒªãƒƒã‚¯ã—ã¦é–‹é–‰</span>
                        </summary>
                        <div class="mt-4">
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 text-center">
                                <div class="summary-card p-4 rounded-lg">
                                    <p class="text-sm font-medium text-gray-500">åˆè¨ˆå£²ä¸Š</p>
                                    <p class="mt-1 text-2xl font-semibold text-gray-900">${accountSummary.totalSales.toLocaleString()}å††</p>
                                </div>
                                <div class="summary-card p-4 rounded-lg">
                                    <p class="text-sm font-medium text-gray-500">ç²—åˆ©åˆè¨ˆ</p>
                                    <p class="mt-1 text-2xl font-semibold text-blue-600">${accountSummary.totalGrossProfit.toLocaleString()}å††</p>
                                </div>
                                <div class="summary-card p-4 rounded-lg">
                                    <p class="text-sm font-medium text-gray-500">ç·çµŒè²»</p>
                                    <p class="mt-1 text-2xl font-semibold text-red-600">${Math.abs(accountSummary.totalExpenses).toLocaleString()}å††</p>
                                </div>
                                <div class="summary-card p-4 rounded-lg">
                                    <p class="text-sm font-medium text-gray-500">æœ€çµ‚åˆ©ç›Š</p>
                                    <p class="mt-1 text-2xl font-semibold ${finalProfitColor}">${accountSummary.finalProfit.toLocaleString()}å††</p>
                                </div>
                            </div>
                        </div>
                    </details>
                    ${orderDetails && orderDetails.length > 0 ? `
                    <details class="border rounded-lg p-4">
                        <summary class="font-semibold text-xl flex justify-between items-center">
                            <span>å£²ä¸Šè©³ç´°</span>
                            <span class="text-sm text-gray-500">ã‚¯ãƒªãƒƒã‚¯ã—ã¦é–‹é–‰</span>
                        </summary>
                        <div class="mt-4 overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200" id="table-orders-${accountName}"></table>
                        </div>
                    </details>` : ''}
                </div>`;
            
            if (orderDetails && orderDetails.length > 0) {
                renderTable(`table-orders-${accountName}`, orderDetails);
            }
        }
        
        function renderTable(tableId, data) {
            const table = document.getElementById(tableId);
            if (!table) return;
            if (data.length === 0) {
                table.innerHTML = '<tbody><tr><td class="p-4 text-center text-gray-500">è©²å½“ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr></tbody>';
                return;
            };
            const headers = Object.keys(data[0]);
            const thead = `<thead><tr class="bg-gray-50">${headers.map(h => `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${h}</th>`).join('')}</tr></thead>`;
            const tbody = `<tbody>${data.map(row => `<tr>${headers.map(h => `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${typeof row[h] === 'number' ? row[h].toLocaleString() : (row[h] || '')}</td>`).join('')}</tr>`).join('')}</tbody>`;
            table.innerHTML = thead + tbody;
        }
        
        function renderGrandTotal(allData) {
            const container = document.getElementById('grandTotalResult');
            container.innerHTML = '';
            
            const validData = allData.filter(d => d && d.accountSummary);
            if (validData.length === 0) return;

            const grandTotalSales = validData.reduce((sum, d) => sum + d.accountSummary.totalSales, 0);
            const grandTotalGrossProfit = validData.reduce((sum, d) => sum + d.accountSummary.totalGrossProfit, 0);
            const grandTotalExpenses = validData.reduce((sum, d) => sum + d.accountSummary.totalExpenses, 0);
            const grandTotalFinalProfit = validData.reduce((sum, d) => sum + d.accountSummary.finalProfit, 0);

            const finalProfitColor = grandTotalFinalProfit >= 0 ? 'text-green-600' : 'text-red-600';

            container.innerHTML = `
                <div class="bg-indigo-800 text-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-4 text-center">ç·åˆè¨ˆã‚µãƒãƒªãƒ¼</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 text-center">
                        <div class="bg-indigo-700 p-4 rounded-lg">
                            <p class="text-sm font-medium text-indigo-200">åˆè¨ˆå£²ä¸Š</p>
                            <p class="mt-1 text-2xl font-semibold">${grandTotalSales.toLocaleString()}å††</p>
                        </div>
                        <div class="bg-indigo-700 p-4 rounded-lg">
                            <p class="text-sm font-medium text-indigo-200">ç²—åˆ©åˆè¨ˆ</p>
                            <p class="mt-1 text-2xl font-semibold">${grandTotalGrossProfit.toLocaleString()}å††</p>
                        </div>
                        <div class="bg-indigo-700 p-4 rounded-lg">
                            <p class="text-sm font-medium text-indigo-200">ç·çµŒè²»</p>
                            <p class="mt-1 text-2xl font-semibold">${Math.abs(grandTotalExpenses).toLocaleString()}å††</p>
                        </div>
                        <div class="bg-indigo-700 p-4 rounded-lg">
                            <p class="text-sm font-medium text-indigo-200">æœ€çµ‚åˆ©ç›Š</p>
                            <p class="mt-1 text-2xl font-semibold ${finalProfitColor}">${grandTotalFinalProfit.toLocaleString()}å††</p>
                        </div>
                    </div>
                </div>`;
        }

        processBtn.addEventListener('click', async () => {
            processBtn.disabled = true;
            processBtn.textContent = 'å‡¦ç†ä¸­...';

            try {
                processedDataStore.acc1 = await processAccountData(
                    inputs.acc1.makad.file.files[0], 
                    inputs.acc1.hanro.file.files[0], 
                    inputs.acc1.amazon.file.files[0], 
                    inputs.acc1.ad.file.files[0]
                );
                processedDataStore.acc2 = await processAccountData(
                    inputs.acc2.makad.file.files[0], 
                    inputs.acc2.hanro.file.files[0], 
                    inputs.acc2.amazon.file.files[0], 
                    inputs.acc2.ad.file.files[0]
                );
                processedDataStore.mercari = await processMercariData(inputs.mercari.sales.file.files[0]);
                
                renderAccountResults(inputs.acc1.container, processedDataStore.acc1, 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ1');
                renderAccountResults(inputs.acc2.container, processedDataStore.acc2, 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ2');
                renderAccountResults(inputs.mercari.container, processedDataStore.mercari, 'ãƒ¡ãƒ«ã‚«ãƒªShops');

                const allData = [processedDataStore.acc1, processedDataStore.acc2, processedDataStore.mercari];
                renderGrandTotal(allData);
                renderFinalSummary(allData);
                
                showToast('å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸã€‚');
            } catch (error) {
                console.error('CSVå‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
                showToast('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            } finally {
                processBtn.disabled = false;
                processBtn.textContent = 'å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹';
            }
        });
    </script>
</body>
</html>